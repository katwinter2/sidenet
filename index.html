<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SideNet - Alternate Internet Browser</title>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #12121a;
    --surface2: #1a1a26;
    --border: #2a2a3a;
    --text: #e0e0e8;
    --text-dim: #8888a0;
    --accent: #7c5cfc;
    --accent-glow: #7c5cfc44;
    --accent-hover: #9178ff;
    --danger: #ff4466;
    --green: #44dd88;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* Top toolbar */
  .toolbar {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .nav-buttons {
    display: flex;
    gap: 4px;
  }

  .nav-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text-dim);
    width: 32px;
    height: 32px;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    transition: all 0.15s;
  }

  .nav-btn:hover:not(:disabled) {
    background: var(--surface);
    color: var(--text);
    border-color: var(--accent);
  }

  .nav-btn:disabled {
    opacity: 0.3;
    cursor: default;
  }

  .address-bar {
    flex: 1;
    display: flex;
    align-items: center;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0 12px;
    height: 36px;
    transition: border-color 0.15s;
  }

  .address-bar:focus-within {
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--accent-glow);
  }

  .address-prefix {
    color: var(--text-dim);
    font-size: 13px;
    margin-right: 4px;
    user-select: none;
  }

  .address-input {
    flex: 1;
    background: none;
    border: none;
    color: var(--text);
    font-size: 14px;
    outline: none;
    font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
  }

  .address-input::placeholder { color: var(--text-dim); }

  .go-btn {
    background: var(--accent);
    border: none;
    color: white;
    height: 36px;
    padding: 0 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.15s;
    white-space: nowrap;
  }

  .go-btn:hover { background: var(--accent-hover); }
  .go-btn:disabled { opacity: 0.5; cursor: default; }

  /* Model selector & settings */
  .toolbar-right {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .model-select {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    outline: none;
    max-width: 160px;
  }

  .model-select:focus { border-color: var(--accent); }

  .settings-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text-dim);
    width: 32px;
    height: 32px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
  }

  .settings-btn:hover {
    color: var(--text);
    border-color: var(--accent);
  }

  /* Main content area */
  .content-area {
    flex: 1;
    overflow-y: auto;
    padding: 0;
  }

  .page-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 32px 24px;
  }

  /* Generated page styling */
  .generated-page {
    line-height: 1.7;
    font-size: 15px;
  }

  .generated-page h1 {
    font-size: 28px;
    margin-bottom: 16px;
    color: var(--text);
    border-bottom: 1px solid var(--border);
    padding-bottom: 12px;
  }

  .generated-page h2 {
    font-size: 22px;
    margin: 24px 0 12px;
    color: var(--text);
  }

  .generated-page h3 {
    font-size: 18px;
    margin: 20px 0 8px;
    color: var(--text);
  }

  .generated-page p {
    margin-bottom: 14px;
    color: var(--text);
    opacity: 0.9;
  }

  .generated-page a {
    color: var(--accent);
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: all 0.15s;
    cursor: pointer;
  }

  .generated-page a:hover {
    color: var(--accent-hover);
    border-bottom-color: var(--accent-hover);
  }

  .generated-page ul, .generated-page ol {
    margin: 0 0 14px 24px;
  }

  .generated-page li { margin-bottom: 6px; }

  .generated-page blockquote {
    border-left: 3px solid var(--accent);
    padding: 8px 16px;
    margin: 14px 0;
    background: var(--surface);
    border-radius: 0 6px 6px 0;
    color: var(--text-dim);
  }

  .generated-page code {
    background: var(--surface2);
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'SF Mono', 'Fira Code', monospace;
    font-size: 13px;
  }

  .generated-page pre {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    overflow-x: auto;
    margin: 14px 0;
  }

  .generated-page pre code {
    background: none;
    padding: 0;
  }

  .generated-page img, .page-image {
    max-width: 100%;
    border-radius: 8px;
    margin: 16px 0;
    border: 1px solid var(--border);
  }

  .generated-page table {
    width: 100%;
    border-collapse: collapse;
    margin: 14px 0;
  }

  .generated-page th, .generated-page td {
    border: 1px solid var(--border);
    padding: 8px 12px;
    text-align: left;
  }

  .generated-page th {
    background: var(--surface2);
    font-weight: 600;
  }

  .generated-page hr {
    border: none;
    border-top: 1px solid var(--border);
    margin: 24px 0;
  }

  /* Loading state */
  .loading-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 60vh;
    gap: 20px;
  }

  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .loading-text {
    color: var(--text-dim);
    font-size: 14px;
    text-align: center;
  }

  .loading-step {
    color: var(--accent);
    font-size: 13px;
    margin-top: 4px;
  }

  /* Welcome screen */
  .welcome {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 70vh;
    text-align: center;
    gap: 16px;
  }

  .welcome-logo {
    font-size: 48px;
    font-weight: 800;
    background: linear-gradient(135deg, var(--accent), #ff66aa);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .welcome-sub {
    color: var(--text-dim);
    font-size: 16px;
    max-width: 440px;
    line-height: 1.6;
  }

  .welcome-hints {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
    margin-top: 16px;
  }

  .hint-chip {
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 8px 14px;
    border-radius: 20px;
    font-size: 13px;
    color: var(--text-dim);
    cursor: pointer;
    transition: all 0.15s;
  }

  .hint-chip:hover {
    border-color: var(--accent);
    color: var(--text);
    background: var(--surface2);
  }

  /* Settings modal */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(4px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 100;
  }

  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    width: 420px;
    max-width: 90vw;
  }

  .modal h2 {
    font-size: 18px;
    margin-bottom: 20px;
  }

  .form-group {
    margin-bottom: 16px;
  }

  .form-group label {
    display: block;
    font-size: 13px;
    color: var(--text-dim);
    margin-bottom: 6px;
  }

  .form-group input {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 14px;
    outline: none;
    font-family: 'SF Mono', 'Fira Code', monospace;
  }

  .form-group input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--accent-glow);
  }

  .form-hint {
    font-size: 11px;
    color: var(--text-dim);
    margin-top: 4px;
  }

  .modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    margin-top: 20px;
  }

  .btn-secondary {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
  }

  .btn-primary {
    background: var(--accent);
    border: none;
    color: white;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
  }

  .btn-primary:hover { background: var(--accent-hover); }

  /* Error state */
  .error-banner {
    background: #ff446620;
    border: 1px solid var(--danger);
    color: var(--danger);
    padding: 12px 16px;
    border-radius: 8px;
    margin: 16px 0;
    font-size: 14px;
  }

  /* Image placeholder during loading */
  .image-placeholder {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 40px;
    text-align: center;
    color: var(--text-dim);
    margin: 16px 0;
    animation: pulse 1.5s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 0.6; }
    50% { opacity: 1; }
  }

  /* Scrollbar */
  .content-area::-webkit-scrollbar { width: 8px; }
  .content-area::-webkit-scrollbar-track { background: var(--bg); }
  .content-area::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 4px;
  }
  .content-area::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

  /* Status bar */
  .status-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 4px 12px;
    background: var(--surface);
    border-top: 1px solid var(--border);
    font-size: 11px;
    color: var(--text-dim);
    flex-shrink: 0;
  }

  .api-status {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--danger);
  }

  .status-dot.connected { background: var(--green); }

  /* History panel */
  .history-panel {
    position: fixed;
    top: 0;
    right: -380px;
    width: 380px;
    height: 100vh;
    background: var(--surface);
    border-left: 1px solid var(--border);
    z-index: 90;
    display: flex;
    flex-direction: column;
    transition: right 0.25s ease;
  }

  .history-panel.open { right: 0; }

  .history-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .history-header h3 {
    font-size: 15px;
    font-weight: 600;
  }

  .history-header-actions {
    display: flex;
    gap: 6px;
  }

  .history-header-actions button {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text-dim);
    padding: 4px 10px;
    border-radius: 5px;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.15s;
  }

  .history-header-actions button:hover {
    color: var(--text);
    border-color: var(--accent);
  }

  .history-list {
    flex: 1;
    overflow-y: auto;
    padding: 8px 0;
  }

  .history-list::-webkit-scrollbar { width: 6px; }
  .history-list::-webkit-scrollbar-track { background: transparent; }
  .history-list::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 3px;
  }

  .history-empty {
    text-align: center;
    color: var(--text-dim);
    padding: 40px 16px;
    font-size: 13px;
  }

  .history-date-group {
    padding: 8px 16px 4px;
    font-size: 11px;
    font-weight: 600;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .history-item {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 10px 16px;
    cursor: pointer;
    transition: background 0.1s;
    border-bottom: 1px solid var(--border);
  }

  .history-item:hover { background: var(--surface2); }

  .history-item-content {
    flex: 1;
    min-width: 0;
  }

  .history-item-title {
    font-size: 13px;
    font-weight: 500;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .history-item-url {
    font-size: 11px;
    color: var(--text-dim);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-top: 2px;
    font-family: 'SF Mono', 'Fira Code', monospace;
  }

  .history-item-time {
    font-size: 11px;
    color: var(--text-dim);
    white-space: nowrap;
    flex-shrink: 0;
    margin-top: 2px;
  }

  .history-item-delete {
    background: none;
    border: none;
    color: var(--text-dim);
    cursor: pointer;
    font-size: 14px;
    padding: 0 2px;
    opacity: 0;
    transition: opacity 0.1s;
    flex-shrink: 0;
  }

  .history-item:hover .history-item-delete { opacity: 1; }
  .history-item-delete:hover { color: var(--danger); }

  .history-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.3);
    z-index: 89;
    display: none;
  }

  .history-backdrop.open { display: block; }

  /* Feed panel (left side) */
  .feed-panel {
    position: fixed;
    top: 0;
    left: -420px;
    width: 420px;
    height: 100vh;
    background: var(--surface);
    border-right: 1px solid var(--border);
    z-index: 90;
    display: flex;
    flex-direction: column;
    transition: left 0.25s ease;
  }

  .feed-panel.open { left: 0; }

  .feed-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .feed-header h3 { font-size: 15px; font-weight: 600; }

  .feed-header-actions {
    display: flex;
    gap: 6px;
  }

  .feed-header-actions button {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text-dim);
    padding: 4px 10px;
    border-radius: 5px;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.15s;
  }

  .feed-header-actions button:hover {
    color: var(--text);
    border-color: var(--accent);
  }

  .feed-list {
    flex: 1;
    overflow-y: auto;
    padding: 8px 0;
  }

  .feed-list::-webkit-scrollbar { width: 6px; }
  .feed-list::-webkit-scrollbar-track { background: transparent; }
  .feed-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  .feed-empty {
    text-align: center;
    color: var(--text-dim);
    padding: 40px 16px;
    font-size: 13px;
    line-height: 1.6;
  }

  .feed-card {
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: background 0.1s;
  }

  .feed-card:hover { background: var(--surface2); }

  .feed-card-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .feed-card-url {
    font-size: 11px;
    color: var(--accent);
    font-family: 'SF Mono', 'Fira Code', monospace;
    margin-bottom: 6px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .feed-card-preview {
    font-size: 12px;
    color: var(--text-dim);
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    margin-bottom: 8px;
  }

  .feed-card-meta {
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 11px;
    color: var(--text-dim);
  }

  .feed-card-author {
    font-weight: 500;
    color: var(--text);
  }

  .feed-card-model {
    background: var(--bg);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 10px;
  }

  .feed-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.3);
    z-index: 89;
    display: none;
  }

  .feed-backdrop.open { display: block; }

  /* Share button on generated pages */
  .share-bar {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 0;
    margin-top: 20px;
    border-top: 1px solid var(--border);
  }

  .share-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text-dim);
    padding: 6px 14px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.15s;
  }

  .share-btn:hover {
    color: var(--text);
    border-color: var(--accent);
  }

  .share-btn.shared {
    color: var(--green);
    border-color: var(--green);
    cursor: default;
  }

  .feed-status {
    font-size: 11px;
    color: var(--text-dim);
  }
</style>
</head>
<body>

<!-- Toolbar -->
<div class="toolbar">
  <div class="nav-buttons">
    <button class="nav-btn" id="backBtn" disabled title="Back">&#8592;</button>
    <button class="nav-btn" id="forwardBtn" disabled title="Forward">&#8594;</button>
  </div>

  <div class="address-bar">
    <span class="address-prefix">side://</span>
    <input
      type="text"
      class="address-input"
      id="addressInput"
      placeholder="Enter a URL or describe a page..."
      autocomplete="off"
    />
  </div>

  <button class="go-btn" id="goBtn">Go</button>

  <div class="toolbar-right">
    <select class="model-select" id="modelSelect">
      <optgroup label="Free Models">
        <option value="openai">GPT-5 Mini (default)</option>
        <option value="openai-fast">GPT-5 Nano (fast)</option>
        <option value="gemini-fast">Gemini 2.5 Flash Lite</option>
        <option value="claude-fast">Claude Haiku 4.5</option>
        <option value="mistral">Mistral Small 3.2</option>
        <option value="deepseek">DeepSeek V3.2</option>
        <option value="qwen-coder">Qwen3 Coder 30B</option>
        <option value="nova-fast">Nova Micro (fastest)</option>
      </optgroup>
      <optgroup label="Paid Models (requires Pollen)">
        <option value="claude">Claude Sonnet 4.5</option>
        <option value="openai-large">GPT-5.2</option>
        <option value="gemini">Gemini 3 Flash</option>
        <option value="grok">Grok 4 Fast</option>
      </optgroup>
    </select>
    <button class="settings-btn" id="feedBtn" title="Community Feed">&#9733;</button>
    <button class="settings-btn" id="historyBtn" title="History">&#9776;</button>
    <button class="settings-btn" id="settingsBtn" title="Settings">&#9881;</button>
  </div>
</div>

<!-- Main content -->
<div class="content-area" id="contentArea">
  <div class="page-container" id="pageContainer">
    <div class="welcome">
      <div class="welcome-logo">SideNet</div>
      <p class="welcome-sub">
        Browse the alternate internet. Type a URL or describe any page you want to visit.
        Pages are generated with AI, complete with images and working links.
      </p>
      <div class="welcome-hints">
        <div class="hint-chip" onclick="navigateTo('en.wikipedia.alt/wiki/The_Great_Martian_Canal_System')">wikipedia.alt/Martian Canals</div>
        <div class="hint-chip" onclick="navigateTo('news.alternate/2099/quantum-internet-goes-live')">Future News</div>
        <div class="hint-chip" onclick="navigateTo('recipes.alt/interdimensional-cooking/phase-shifted-pasta')">Interdimensional Recipes</div>
        <div class="hint-chip" onclick="navigateTo('shop.parallel/products/gravity-boots-pro')">Gravity Boots Store</div>
        <div class="hint-chip" onclick="navigateTo('A forum discussing the best places to visit in the dream world')">Dream Travel Forum</div>
      </div>
    </div>
  </div>
</div>

<!-- Status bar -->
<div class="status-bar">
  <div class="api-status">
    <div class="status-dot" id="statusDot"></div>
    <span id="statusText">No API key set</span>
  </div>
  <span id="modelStatus">Model: openai</span>
</div>

<!-- Feed panel -->
<div class="feed-backdrop" id="feedBackdrop"></div>
<div class="feed-panel" id="feedPanel">
  <div class="feed-header">
    <h3>Community Feed</h3>
    <div class="feed-header-actions">
      <button id="refreshFeedBtn">Refresh</button>
      <button id="closeFeedBtn">Close</button>
    </div>
  </div>
  <div class="feed-list" id="feedList">
    <div class="feed-empty">Loading community pages...</div>
  </div>
</div>

<!-- History panel -->
<div class="history-backdrop" id="historyBackdrop"></div>
<div class="history-panel" id="historyPanel">
  <div class="history-header">
    <h3>History</h3>
    <div class="history-header-actions">
      <button id="clearHistoryBtn">Clear all</button>
      <button id="closeHistoryBtn">Close</button>
    </div>
  </div>
  <div class="history-list" id="historyList">
    <div class="history-empty">No pages visited yet.</div>
  </div>
</div>

<!-- Settings modal -->
<div class="modal-overlay" id="settingsModal">
  <div class="modal">
    <h2>Settings</h2>
    <div class="form-group">
      <label>Pollinations API Key</label>
      <input type="password" id="apiKeyInput" placeholder="pk_... or sk_..." />
      <div class="form-hint">
        Optional for free models. Get a key at <a href="https://enter.pollinations.ai" target="_blank" style="color:var(--accent)">enter.pollinations.ai</a>
      </div>
    </div>
    <div class="form-group">
      <label>Images per page (1-3)</label>
      <input type="number" id="imagesPerPage" min="1" max="3" value="2" />
      <div class="form-hint">How many AI images to generate per page</div>
    </div>
    <hr style="border:none;border-top:1px solid var(--border);margin:20px 0" />
    <div class="form-group">
      <label>Display Name (for community feed)</label>
      <input type="text" id="displayNameInput" placeholder="Anonymous" style="font-family:inherit" />
      <div class="form-hint">Shown when you share pages to the feed</div>
    </div>
    <div class="form-group">
      <label>Firebase Config (JSON)</label>
      <textarea id="firebaseConfigInput" rows="4" placeholder='{"apiKey":"...","databaseURL":"...","projectId":"..."}' style="width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:6px;font-size:12px;outline:none;font-family:'SF Mono','Fira Code',monospace;resize:vertical"></textarea>
      <div class="form-hint">
        Paste your Firebase Realtime Database config to enable the community feed.
        <a href="https://console.firebase.google.com" target="_blank" style="color:var(--accent)">Create a project</a> with Realtime Database (test mode rules).
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-secondary" id="cancelSettings">Cancel</button>
      <button class="btn-primary" id="saveSettings">Save</button>
    </div>
  </div>
</div>

<script>
// ── State ──
const state = {
  apiKey: localStorage.getItem('sidenet_apiKey') || '',
  imagesPerPage: parseInt(localStorage.getItem('sidenet_imagesPerPage') || '2'),
  displayName: localStorage.getItem('sidenet_displayName') || '',
  firebaseConfig: localStorage.getItem('sidenet_firebaseConfig') || '',
  history: [],
  historyIndex: -1,
  isLoading: false,
  firebaseReady: false,
  currentPageUrl: null,
};

// ── DOM refs ──
const $ = (sel) => document.querySelector(sel);
const addressInput = $('#addressInput');
const goBtn = $('#goBtn');
const backBtn = $('#backBtn');
const forwardBtn = $('#forwardBtn');
const modelSelect = $('#modelSelect');
const settingsBtn = $('#settingsBtn');
const settingsModal = $('#settingsModal');
const apiKeyInput = $('#apiKeyInput');
const imagesPerPageInput = $('#imagesPerPage');
const saveSettingsBtn = $('#saveSettings');
const cancelSettingsBtn = $('#cancelSettings');
const pageContainer = $('#pageContainer');
const statusDot = $('#statusDot');
const statusText = $('#statusText');
const modelStatus = $('#modelStatus');
const historyBtn = $('#historyBtn');
const historyPanel = $('#historyPanel');
const historyBackdrop = $('#historyBackdrop');
const historyList = $('#historyList');
const clearHistoryBtn = $('#clearHistoryBtn');
const closeHistoryBtn = $('#closeHistoryBtn');
const feedBtn = $('#feedBtn');
const feedPanel = $('#feedPanel');
const feedBackdrop = $('#feedBackdrop');
const feedList = $('#feedList');
const refreshFeedBtn = $('#refreshFeedBtn');
const closeFeedBtn = $('#closeFeedBtn');
const displayNameInput = $('#displayNameInput');
const firebaseConfigInput = $('#firebaseConfigInput');

// ── Init ──
updateStatusBar();
apiKeyInput.value = state.apiKey;
imagesPerPageInput.value = state.imagesPerPage;
displayNameInput.value = state.displayName;
firebaseConfigInput.value = state.firebaseConfig;
initFirebase();

// ── Settings ──
settingsBtn.addEventListener('click', () => {
  settingsModal.classList.add('open');
  apiKeyInput.value = state.apiKey;
  imagesPerPageInput.value = state.imagesPerPage;
  displayNameInput.value = state.displayName;
  firebaseConfigInput.value = state.firebaseConfig;
});

cancelSettingsBtn.addEventListener('click', () => settingsModal.classList.remove('open'));

settingsModal.addEventListener('click', (e) => {
  if (e.target === settingsModal) settingsModal.classList.remove('open');
});

saveSettingsBtn.addEventListener('click', () => {
  state.apiKey = apiKeyInput.value.trim();
  state.imagesPerPage = Math.min(3, Math.max(1, parseInt(imagesPerPageInput.value) || 2));
  state.displayName = displayNameInput.value.trim();
  const newFirebaseConfig = firebaseConfigInput.value.trim();
  const firebaseChanged = newFirebaseConfig !== state.firebaseConfig;
  state.firebaseConfig = newFirebaseConfig;
  localStorage.setItem('sidenet_apiKey', state.apiKey);
  localStorage.setItem('sidenet_imagesPerPage', state.imagesPerPage);
  localStorage.setItem('sidenet_displayName', state.displayName);
  localStorage.setItem('sidenet_firebaseConfig', state.firebaseConfig);
  settingsModal.classList.remove('open');
  updateStatusBar();
  if (firebaseChanged) initFirebase();
});

function updateStatusBar() {
  if (state.apiKey) {
    statusDot.classList.add('connected');
    const keyPreview = state.apiKey.substring(0, 5) + '...';
    statusText.textContent = `Key: ${keyPreview}`;
  } else {
    statusDot.classList.remove('connected');
    statusText.textContent = 'No API key (using free tier)';
  }
  modelStatus.textContent = `Model: ${modelSelect.value}`;
}

modelSelect.addEventListener('change', updateStatusBar);

// ── Navigation ──
addressInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !state.isLoading) {
    navigateTo(addressInput.value.trim());
  }
});

goBtn.addEventListener('click', () => {
  if (!state.isLoading) navigateTo(addressInput.value.trim());
});

backBtn.addEventListener('click', () => {
  if (state.historyIndex > 0) {
    state.historyIndex--;
    const entry = state.history[state.historyIndex];
    addressInput.value = entry.url;
    pageContainer.innerHTML = entry.html;
    bindPageLinks();
    updateNavButtons();
  }
});

forwardBtn.addEventListener('click', () => {
  if (state.historyIndex < state.history.length - 1) {
    state.historyIndex++;
    const entry = state.history[state.historyIndex];
    addressInput.value = entry.url;
    pageContainer.innerHTML = entry.html;
    bindPageLinks();
    updateNavButtons();
  }
});

function updateNavButtons() {
  backBtn.disabled = state.historyIndex <= 0;
  forwardBtn.disabled = state.historyIndex >= state.history.length - 1;
}

// ── Main page generation ──
async function navigateTo(query) {
  if (!query) return;
  state.isLoading = true;
  goBtn.disabled = true;
  addressInput.value = query;

  // Show loading
  pageContainer.innerHTML = `
    <div class="loading-container">
      <div class="loading-spinner"></div>
      <div class="loading-text">Connecting to the alternate internet...</div>
      <div class="loading-step" id="loadingStep">Generating page content...</div>
    </div>
  `;

  try {
    // Step 1: Generate page HTML
    const pageHTML = await generatePage(query);

    // Step 2: Parse out image placeholders and render page
    const { html, imagePrompts } = parseAndInsertImages(pageHTML);
    pageContainer.innerHTML = `<div class="generated-page">${html}</div>`;

    // Step 3: Generate images in parallel
    const limitedPrompts = imagePrompts.slice(0, state.imagesPerPage);
    if (limitedPrompts.length > 0) {
      await generateImages(limitedPrompts);
    }

    // Bind link clicks and add share bar
    bindPageLinks();
    state.currentPageUrl = query;
    injectShareBar(query);

    // Save to session history
    state.history = state.history.slice(0, state.historyIndex + 1);
    state.history.push({ url: query, html: pageContainer.innerHTML });
    state.historyIndex = state.history.length - 1;
    updateNavButtons();

    // Save to persistent history
    savePersistentHistory({
      url: query,
      title: extractTitle(pageContainer.innerHTML) || query,
      html: pageContainer.innerHTML,
      timestamp: Date.now(),
      model: modelSelect.value,
    });

    // Scroll to top
    $('#contentArea').scrollTop = 0;

  } catch (err) {
    pageContainer.innerHTML = `
      <div class="page-container">
        <div class="error-banner">
          <strong>Connection failed:</strong> ${escapeHtml(err.message)}
        </div>
        <p style="color:var(--text-dim);margin-top:12px;">
          Check your API key in settings, or try a different model.
        </p>
      </div>
    `;
  }

  state.isLoading = false;
  goBtn.disabled = false;
}

// ── Text generation ──
async function generatePage(query) {
  const model = modelSelect.value;
  const systemPrompt = `You are SideNet, an AI that generates creative, detailed HTML pages for an alternate-reality internet browser.

RULES:
- Output ONLY raw HTML content (no \`\`\`html blocks, no markdown, no explanations)
- Use semantic HTML: h1, h2, h3, p, ul, ol, blockquote, table, pre, code, hr, etc.
- Include 1-3 images using this EXACT format: <img data-ai-prompt="detailed image description here" alt="description" />
- Include 3-6 hyperlinks using this format: <a href="side://some-url-path">Link Text</a>
  - Links should point to related pages on this alternate internet
  - Use creative, plausible URLs like side://en.wikipedia.alt/wiki/Topic or side://news.alt/article-slug
- Make the content creative, detailed, internally consistent, and immersive
- Pages should feel like real websites from a parallel universe - wikis, shops, forums, news sites, blogs, documentation, etc.
- Be inventive with alternate history, science, culture, and technology
- Content should be 300-600 words
- Do NOT include <html>, <head>, <body>, or <style> tags - just the inner content`;

  const userPrompt = `Generate the webpage for: ${query}

This is a page on the alternate internet. Create rich, immersive content with images and links to other pages.`;

  const response = await fetch('https://gen.pollinations.ai/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      ...(state.apiKey ? { 'Authorization': `Bearer ${state.apiKey}` } : {}),
    },
    body: JSON.stringify({
      model: model,
      messages: [
        { role: 'system', content: systemPrompt },
        { role: 'user', content: userPrompt },
      ],
      temperature: 0.85,
      max_tokens: 2048,
    }),
  });

  if (!response.ok) {
    const errText = await response.text();
    throw new Error(`API error ${response.status}: ${errText.substring(0, 200)}`);
  }

  const data = await response.json();
  let content = data.choices[0].message.content;
  // Strip markdown code fences if the model wrapped its output
  content = content.replace(/^```html?\s*\n?/i, '').replace(/\n?```\s*$/i, '');
  return content;
}

// ── Image handling ──
function parseAndInsertImages(html) {
  const imagePrompts = [];
  let idx = 0;

  // Find all <img data-ai-prompt="..."> tags and replace with placeholders
  const processed = html.replace(
    /<img\s+data-ai-prompt="([^"]+)"[^>]*\/?>/gi,
    (match, prompt) => {
      const id = `ai-img-${idx}`;
      imagePrompts.push({ id, prompt });
      idx++;
      return `<div class="image-placeholder" id="${id}">Generating image: "${escapeHtml(prompt.substring(0, 80))}..."</div>`;
    }
  );

  return { html: processed, imagePrompts };
}

async function generateImages(prompts) {
  const promises = prompts.map(async ({ id, prompt }) => {
    try {
      const encodedPrompt = encodeURIComponent(prompt);
      const params = new URLSearchParams({
        model: 'flux',
        width: '768',
        height: '512',
        nologo: 'true',
      });
      if (state.apiKey) params.set('key', state.apiKey);

      const url = `https://image.pollinations.ai/prompt/${encodedPrompt}?${params}`;

      // Create image element and wait for load
      const placeholder = document.getElementById(id);
      if (!placeholder) return;

      const img = document.createElement('img');
      img.className = 'page-image';
      img.alt = prompt;
      img.src = url;

      await new Promise((resolve, reject) => {
        img.onload = resolve;
        img.onerror = () => {
          // Fallback: try gen.pollinations.ai endpoint
          const fallbackUrl = `https://gen.pollinations.ai/image/${encodedPrompt}?${params}`;
          img.onerror = reject;
          img.src = fallbackUrl;
        };
        // timeout after 60s
        setTimeout(resolve, 60000);
      });

      placeholder.replaceWith(img);
    } catch {
      const placeholder = document.getElementById(id);
      if (placeholder) {
        placeholder.textContent = '[Image failed to load]';
        placeholder.style.animation = 'none';
        placeholder.style.opacity = '0.4';
      }
    }
  });

  await Promise.allSettled(promises);
}

// ── Link binding ──
function bindPageLinks() {
  pageContainer.querySelectorAll('a[href]').forEach((link) => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      let href = link.getAttribute('href');
      // Strip side:// prefix for clean display
      href = href.replace(/^side:\/\//, '');
      navigateTo(href);
    });
  });
}

// ── Persistent History ──
function loadSavedHistory() {
  try {
    return JSON.parse(localStorage.getItem('sidenet_history') || '[]');
  } catch { return []; }
}

function savePersistentHistory(entry) {
  const saved = loadSavedHistory();
  saved.unshift(entry);
  // Keep max 200 entries, trim HTML to avoid hitting storage limits
  const trimmed = saved.slice(0, 200).map(e => ({
    ...e,
    html: (e.html || '').substring(0, 50000),
  }));
  try {
    localStorage.setItem('sidenet_history', JSON.stringify(trimmed));
  } catch {
    // Storage full — drop oldest half
    const halved = trimmed.slice(0, 100);
    localStorage.setItem('sidenet_history', JSON.stringify(halved));
  }
}

function deleteSavedHistoryEntry(timestamp) {
  const saved = loadSavedHistory().filter(e => e.timestamp !== timestamp);
  localStorage.setItem('sidenet_history', JSON.stringify(saved));
  renderHistoryPanel();
}

function clearSavedHistory() {
  localStorage.removeItem('sidenet_history');
  renderHistoryPanel();
}

function extractTitle(html) {
  const m = html.match(/<h1[^>]*>(.*?)<\/h1>/i);
  if (m) {
    const tmp = document.createElement('div');
    tmp.innerHTML = m[1];
    return tmp.textContent.substring(0, 100);
  }
  return null;
}

function formatTime(ts) {
  const d = new Date(ts);
  return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function formatDateGroup(ts) {
  const d = new Date(ts);
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const date = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const diff = (today - date) / 86400000;
  if (diff === 0) return 'Today';
  if (diff === 1) return 'Yesterday';
  if (diff < 7) return d.toLocaleDateString([], { weekday: 'long' });
  return d.toLocaleDateString([], { month: 'short', day: 'numeric', year: 'numeric' });
}

function renderHistoryPanel() {
  const saved = loadSavedHistory();
  if (saved.length === 0) {
    historyList.innerHTML = '<div class="history-empty">No pages visited yet.</div>';
    return;
  }

  let html = '';
  let currentGroup = '';

  for (const entry of saved) {
    const group = formatDateGroup(entry.timestamp);
    if (group !== currentGroup) {
      currentGroup = group;
      html += `<div class="history-date-group">${escapeHtml(group)}</div>`;
    }
    const title = escapeHtml(entry.title || entry.url);
    const url = escapeHtml(entry.url);
    const time = formatTime(entry.timestamp);
    html += `
      <div class="history-item" data-ts="${entry.timestamp}" data-url="${escapeHtml(entry.url)}">
        <div class="history-item-content">
          <div class="history-item-title">${title}</div>
          <div class="history-item-url">side://${url}</div>
        </div>
        <span class="history-item-time">${time}</span>
        <button class="history-item-delete" data-delete-ts="${entry.timestamp}" title="Remove">&times;</button>
      </div>`;
  }

  historyList.innerHTML = html;

  // Bind clicks
  historyList.querySelectorAll('.history-item').forEach(item => {
    item.addEventListener('click', (e) => {
      if (e.target.closest('.history-item-delete')) return;
      const ts = parseInt(item.dataset.ts);
      const entry = loadSavedHistory().find(e => e.timestamp === ts);
      if (entry && entry.html) {
        // Restore cached page
        addressInput.value = entry.url;
        pageContainer.innerHTML = entry.html;
        bindPageLinks();
        // Push to session nav history
        state.history = state.history.slice(0, state.historyIndex + 1);
        state.history.push({ url: entry.url, html: entry.html });
        state.historyIndex = state.history.length - 1;
        updateNavButtons();
        $('#contentArea').scrollTop = 0;
      } else {
        // Re-generate if no cached HTML
        navigateTo(item.dataset.url);
      }
      toggleHistory(false);
    });
  });

  historyList.querySelectorAll('.history-item-delete').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      deleteSavedHistoryEntry(parseInt(btn.dataset.deleteTs));
    });
  });
}

function toggleHistory(forceOpen) {
  const open = forceOpen !== undefined ? forceOpen : !historyPanel.classList.contains('open');
  historyPanel.classList.toggle('open', open);
  historyBackdrop.classList.toggle('open', open);
  if (open) renderHistoryPanel();
}

historyBtn.addEventListener('click', () => toggleHistory());
closeHistoryBtn.addEventListener('click', () => toggleHistory(false));
historyBackdrop.addEventListener('click', () => toggleHistory(false));
clearHistoryBtn.addEventListener('click', () => {
  if (confirm('Clear all browsing history?')) clearSavedHistory();
});

// ── Firebase & Community Feed ──
let firebaseDb = null;

function initFirebase() {
  if (!state.firebaseConfig) {
    state.firebaseReady = false;
    return;
  }
  try {
    const config = JSON.parse(state.firebaseConfig);
    // Delete existing app if re-initializing
    if (firebase.apps.length) {
      firebase.app().delete().then(() => startFirebase(config));
    } else {
      startFirebase(config);
    }
  } catch {
    state.firebaseReady = false;
  }
}

function startFirebase(config) {
  try {
    firebase.initializeApp(config);
    firebaseDb = firebase.database();
    state.firebaseReady = true;
  } catch {
    state.firebaseReady = false;
  }
}

async function shareToFeed(url, title, html) {
  if (!state.firebaseReady || !firebaseDb) {
    alert('Community feed not configured. Add your Firebase config in Settings.');
    return;
  }
  // Strip large image src attributes to save space, keep the structure
  const cleanHtml = html.substring(0, 40000);
  // Extract a text preview
  const tmp = document.createElement('div');
  tmp.innerHTML = cleanHtml;
  const preview = tmp.textContent.substring(0, 200).trim();

  const entry = {
    url,
    title: title || url,
    preview,
    html: cleanHtml,
    author: state.displayName || 'Anonymous',
    model: modelSelect.value,
    timestamp: Date.now(),
  };

  try {
    await firebaseDb.ref('feed').push(entry);
    return true;
  } catch (err) {
    alert('Failed to share: ' + err.message);
    return false;
  }
}

async function loadFeed() {
  if (!state.firebaseReady || !firebaseDb) {
    feedList.innerHTML = `
      <div class="feed-empty">
        Community feed not connected.<br/><br/>
        Add your Firebase config in Settings to see and share pages with others.
      </div>`;
    return;
  }
  feedList.innerHTML = '<div class="feed-empty">Loading...</div>';
  try {
    const snap = await firebaseDb.ref('feed')
      .orderByChild('timestamp')
      .limitToLast(50)
      .once('value');
    const entries = [];
    snap.forEach(child => {
      entries.push({ key: child.key, ...child.val() });
    });
    entries.reverse(); // newest first
    renderFeed(entries);
  } catch (err) {
    feedList.innerHTML = `<div class="feed-empty">Error loading feed: ${escapeHtml(err.message)}</div>`;
  }
}

function renderFeed(entries) {
  if (entries.length === 0) {
    feedList.innerHTML = '<div class="feed-empty">No shared pages yet. Be the first to share!</div>';
    return;
  }

  let html = '';
  for (const entry of entries) {
    const title = escapeHtml(entry.title || entry.url);
    const url = escapeHtml(entry.url);
    const preview = escapeHtml(entry.preview || '');
    const author = escapeHtml(entry.author || 'Anonymous');
    const model = escapeHtml(entry.model || '?');
    const ago = timeAgo(entry.timestamp);
    html += `
      <div class="feed-card" data-feed-key="${escapeHtml(entry.key)}">
        <div class="feed-card-title">${title}</div>
        <div class="feed-card-url">side://${url}</div>
        <div class="feed-card-preview">${preview}</div>
        <div class="feed-card-meta">
          <span><span class="feed-card-author">${author}</span> &middot; ${ago}</span>
          <span class="feed-card-model">${model}</span>
        </div>
      </div>`;
  }

  feedList.innerHTML = html;

  // Bind card clicks — load the shared page
  feedList.querySelectorAll('.feed-card').forEach(card => {
    card.addEventListener('click', async () => {
      const key = card.dataset.feedKey;
      try {
        const snap = await firebaseDb.ref('feed/' + key).once('value');
        const entry = snap.val();
        if (entry && entry.html) {
          addressInput.value = entry.url;
          pageContainer.innerHTML = entry.html;
          bindPageLinks();
          injectShareBar(entry.url);
          state.currentPageUrl = entry.url;
          state.history = state.history.slice(0, state.historyIndex + 1);
          state.history.push({ url: entry.url, html: pageContainer.innerHTML });
          state.historyIndex = state.history.length - 1;
          updateNavButtons();
          $('#contentArea').scrollTop = 0;
        } else {
          navigateTo(entry.url);
        }
      } catch {
        // Fallback: just navigate
        const url = card.querySelector('.feed-card-url').textContent.replace('side://', '');
        navigateTo(url);
      }
      toggleFeed(false);
    });
  });
}

function timeAgo(ts) {
  const diff = Date.now() - ts;
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return 'just now';
  if (mins < 60) return `${mins}m ago`;
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return `${hrs}h ago`;
  const days = Math.floor(hrs / 24);
  if (days < 7) return `${days}d ago`;
  return new Date(ts).toLocaleDateString([], { month: 'short', day: 'numeric' });
}

function toggleFeed(forceOpen) {
  const open = forceOpen !== undefined ? forceOpen : !feedPanel.classList.contains('open');
  feedPanel.classList.toggle('open', open);
  feedBackdrop.classList.toggle('open', open);
  if (open) loadFeed();
}

feedBtn.addEventListener('click', () => toggleFeed());
closeFeedBtn.addEventListener('click', () => toggleFeed(false));
feedBackdrop.addEventListener('click', () => toggleFeed(false));
refreshFeedBtn.addEventListener('click', () => loadFeed());

// ── Share bar injection ──
function injectShareBar(url) {
  // Remove any existing share bar
  const existing = pageContainer.querySelector('.share-bar');
  if (existing) existing.remove();

  const bar = document.createElement('div');
  bar.className = 'share-bar';
  bar.innerHTML = `
    <button class="share-btn" id="sharePageBtn">Share to Community Feed</button>
    <span class="feed-status" id="shareStatus"></span>
  `;
  // Append inside the generated-page div, or at the end of pageContainer
  const page = pageContainer.querySelector('.generated-page');
  if (page) {
    page.appendChild(bar);
  } else {
    pageContainer.appendChild(bar);
  }

  const shareBtn = bar.querySelector('#sharePageBtn');
  const shareStatusEl = bar.querySelector('#shareStatus');
  shareBtn.addEventListener('click', async () => {
    if (shareBtn.classList.contains('shared')) return;
    shareBtn.textContent = 'Sharing...';
    shareBtn.disabled = true;
    const title = extractTitle(pageContainer.innerHTML) || url;
    const html = pageContainer.innerHTML;
    const ok = await shareToFeed(url, title, html);
    if (ok) {
      shareBtn.textContent = 'Shared!';
      shareBtn.classList.add('shared');
      shareStatusEl.textContent = 'Visible in the community feed';
    } else {
      shareBtn.textContent = 'Share to Community Feed';
      shareBtn.disabled = false;
    }
  });
}

// ── Utils ──
function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}
</script>
</body>
</html>
