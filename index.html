<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>sidenet</title>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
<style>
  :root {
    --bg: #1a1a1a;
    --surface: #242428;
    --surface2: #2c2c32;
    --border: #3a3a42;
    --text: #f0f0f2;
    --text-dim: #9090a0;
    --accent: #f0c8d8;
    --accent-glow: #f0c8d840;
    --accent-hover: #f5a0c0;
    --danger: #ff4466;
    --green: #44dd88;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* Top toolbar */
  .toolbar {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .nav-buttons {
    display: flex;
    gap: 4px;
  }

  .nav-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text-dim);
    width: 32px;
    height: 32px;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    transition: all 0.15s;
  }

  .nav-btn:hover:not(:disabled) {
    background: var(--surface);
    color: var(--text);
    border-color: var(--accent);
  }

  .nav-btn:disabled {
    opacity: 0.3;
    cursor: default;
  }

  .address-bar {
    flex: 1;
    display: flex;
    align-items: center;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0 12px;
    height: 36px;
    transition: border-color 0.15s;
  }

  .address-bar:focus-within {
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--accent-glow);
  }

  .address-prefix {
    color: var(--text-dim);
    font-size: 13px;
    margin-right: 4px;
    user-select: none;
  }

  .address-input {
    flex: 1;
    background: none;
    border: none;
    color: var(--text);
    font-size: 14px;
    outline: none;
    font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
  }

  .address-input::placeholder { color: var(--text-dim); }

  .go-btn {
    background: var(--accent);
    border: none;
    color: #1a1a1a;
    height: 36px;
    padding: 0 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.15s;
    white-space: nowrap;
  }

  .go-btn:hover { background: var(--accent-hover); }
  .go-btn:disabled { opacity: 0.5; cursor: default; }

  /* Model selector & settings */
  .toolbar-right {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .model-select {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    outline: none;
    max-width: 280px;
  }

  .model-select:focus { border-color: var(--accent); }

  .settings-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text-dim);
    width: 32px;
    height: 32px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
  }

  .settings-btn:hover {
    color: var(--text);
    border-color: var(--accent);
  }

  /* Main content area */
  .content-area {
    flex: 1;
    overflow-y: auto;
    padding: 0;
  }

  .page-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 32px 24px;
  }

  /* Generated page styling */
  .generated-page {
    line-height: 1.7;
    font-size: 15px;
  }

  .generated-page h1 {
    font-size: 28px;
    margin-bottom: 16px;
    color: var(--text);
    border-bottom: 1px solid var(--border);
    padding-bottom: 12px;
  }

  .generated-page h2 {
    font-size: 22px;
    margin: 24px 0 12px;
    color: var(--text);
  }

  .generated-page h3 {
    font-size: 18px;
    margin: 20px 0 8px;
    color: var(--text);
  }

  .generated-page p {
    margin-bottom: 14px;
    color: var(--text);
    opacity: 0.9;
  }

  .generated-page a {
    color: var(--accent);
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: all 0.15s;
    cursor: pointer;
  }

  .generated-page a:hover {
    color: var(--accent-hover);
    border-bottom-color: var(--accent-hover);
  }

  .generated-page ul, .generated-page ol {
    margin: 0 0 14px 24px;
  }

  .generated-page li { margin-bottom: 6px; }

  .generated-page blockquote {
    border-left: 3px solid var(--accent);
    padding: 8px 16px;
    margin: 14px 0;
    background: var(--surface);
    border-radius: 0 6px 6px 0;
    color: var(--text-dim);
  }

  .generated-page code {
    background: var(--surface2);
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'SF Mono', 'Fira Code', monospace;
    font-size: 13px;
  }

  .generated-page pre {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    overflow-x: auto;
    margin: 14px 0;
  }

  .generated-page pre code {
    background: none;
    padding: 0;
  }

  .generated-page img, .page-image {
    max-width: 100%;
    border-radius: 8px;
    margin: 16px 0;
    border: 1px solid var(--border);
  }

  .generated-page table {
    width: 100%;
    border-collapse: collapse;
    margin: 14px 0;
  }

  .generated-page th, .generated-page td {
    border: 1px solid var(--border);
    padding: 8px 12px;
    text-align: left;
  }

  .generated-page th {
    background: var(--surface2);
    font-weight: 600;
  }

  .generated-page hr {
    border: none;
    border-top: 1px solid var(--border);
    margin: 24px 0;
  }

  /* Loading state */
  .loading-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 60vh;
    gap: 20px;
  }

  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .loading-text {
    color: var(--text-dim);
    font-size: 14px;
    text-align: center;
  }

  .loading-step {
    color: var(--accent);
    font-size: 13px;
    margin-top: 4px;
  }

  /* Welcome screen */
  .welcome-header {
    text-align: center;
    padding: 32px 0 24px;
  }

  .welcome-logo {
    font-size: 42px;
    font-weight: 800;
    background: linear-gradient(135deg, var(--accent), #e8a0b8);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 8px;
  }

  .welcome-sub {
    color: var(--text-dim);
    font-size: 15px;
    max-width: 440px;
    line-height: 1.6;
    margin: 0 auto;
  }

  .welcome-hints {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
    margin-top: 16px;
  }

  .hint-chip {
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 8px 14px;
    border-radius: 20px;
    font-size: 13px;
    color: var(--text-dim);
    cursor: pointer;
    transition: all 0.15s;
  }

  .hint-chip:hover {
    border-color: var(--accent);
    color: var(--text);
    background: var(--surface2);
  }

  /* Welcome feed section */
  .welcome-feed-section {
    margin-top: 24px;
    border-top: 1px solid var(--border);
    padding-top: 20px;
  }

  .welcome-feed-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }

  .welcome-feed-header h3 {
    font-size: 16px;
    font-weight: 600;
    color: var(--text);
  }

  .welcome-feed-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 12px;
  }

  .welcome-feed-list .feed-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px;
    cursor: pointer;
    transition: all 0.15s;
  }

  .welcome-feed-list .feed-card:hover {
    border-color: var(--accent);
    background: var(--surface2);
    transform: translateY(-1px);
  }

  /* Settings modal */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(4px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 100;
  }

  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    width: 420px;
    max-width: 90vw;
  }

  .modal h2 {
    font-size: 18px;
    margin-bottom: 20px;
  }

  .form-group {
    margin-bottom: 16px;
  }

  .form-group label {
    display: block;
    font-size: 13px;
    color: var(--text-dim);
    margin-bottom: 6px;
  }

  .form-group input {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 14px;
    outline: none;
    font-family: 'SF Mono', 'Fira Code', monospace;
  }

  .form-group input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--accent-glow);
  }

  .form-hint {
    font-size: 11px;
    color: var(--text-dim);
    margin-top: 4px;
  }

  .modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    margin-top: 20px;
  }

  .btn-secondary {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
  }

  .btn-primary {
    background: var(--accent);
    border: none;
    color: #1a1a1a;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
  }

  .btn-primary:hover { background: var(--accent-hover); }

  .btn-danger {
    background: transparent;
    border: 1px solid var(--danger);
    color: var(--danger);
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    transition: all 0.15s;
  }

  .btn-danger:hover {
    background: var(--danger);
    color: white;
  }

  .btn-danger:disabled {
    opacity: 0.4;
    pointer-events: none;
  }

  /* Temperature slider */
  .temperature-control {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .temperature-control input[type="range"] {
    flex: 1;
    -webkit-appearance: none;
    appearance: none;
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    outline: none;
  }

  .temperature-control input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
  }

  .temperature-control input[type="range"]::-webkit-slider-thumb:hover {
    background: var(--accent-hover);
  }

  .temperature-value {
    font-family: 'SF Mono', 'Fira Code', monospace;
    font-size: 13px;
    color: var(--text);
    min-width: 32px;
    text-align: right;
  }

  /* Prompt preset row */
  .prompt-preset-row {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .prompt-preset-row select {
    flex: 1;
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 14px;
    outline: none;
    font-family: inherit;
  }

  .prompt-preset-row select:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--accent-glow);
  }

  .btn-icon {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text-dim);
    width: 34px;
    height: 34px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .btn-icon:hover {
    color: var(--text);
    border-color: var(--accent);
  }

  /* Prompt editor modal */
  .prompt-editor-overlay { z-index: 101; }

  .modal.prompt-editor-modal {
    width: 600px;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
  }

  .prompt-editor-modal textarea {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 10px 12px;
    border-radius: 6px;
    font-size: 13px;
    font-family: 'SF Mono', 'Fira Code', monospace;
    line-height: 1.5;
    resize: vertical;
    min-height: 200px;
    max-height: 400px;
    outline: none;
  }

  .prompt-editor-modal textarea:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--accent-glow);
  }

  .prompt-editor-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 16px;
    gap: 8px;
    flex-wrap: wrap;
  }

  .prompt-editor-actions .left-actions,
  .prompt-editor-actions .right-actions {
    display: flex;
    gap: 8px;
  }

  /* Error state */
  .error-banner {
    background: #ff446620;
    border: 1px solid var(--danger);
    color: var(--danger);
    padding: 12px 16px;
    border-radius: 8px;
    margin: 16px 0;
    font-size: 14px;
  }

  /* Image placeholder during loading */
  .image-placeholder {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 40px;
    text-align: center;
    color: var(--text-dim);
    margin: 16px 0;
    animation: pulse 1.5s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 0.6; }
    50% { opacity: 1; }
  }

  /* Scrollbar */
  .content-area::-webkit-scrollbar { width: 8px; }
  .content-area::-webkit-scrollbar-track { background: var(--bg); }
  .content-area::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 4px;
  }
  .content-area::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

  /* Connection indicator dot */
  .settings-btn-wrapper {
    position: relative;
    display: inline-flex;
  }

  .connection-dot {
    position: absolute;
    top: -2px;
    right: -2px;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--danger);
    border: 2px solid var(--surface);
    z-index: 1;
  }

  .connection-dot.connected { background: var(--green); }

  .connection-dot-tooltip {
    display: none;
    position: absolute;
    bottom: calc(100% + 8px);
    right: 0;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 12px;
    white-space: nowrap;
    z-index: 200;
    pointer-events: none;
  }

  .settings-btn-wrapper:hover .connection-dot:not(.connected) ~ .connection-dot-tooltip {
    display: block;
  }

  /* Constellation overlay */
  .constellation-wrapper {
    position: fixed;
    z-index: 95;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.25s ease;
  }

  .constellation-wrapper.visible {
    opacity: 1;
  }

  .constellation-canvas {
    display: block;
    border-radius: 12px;
    background: radial-gradient(ellipse at center, #1a1a2e 0%, #0d0d14 100%);
    border: 1px solid var(--border);
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  }

  /* History panel */
  .history-panel {
    position: fixed;
    top: 0;
    right: -380px;
    width: 380px;
    height: 100vh;
    background: var(--surface);
    border-left: 1px solid var(--border);
    z-index: 90;
    display: flex;
    flex-direction: column;
    transition: right 0.25s ease;
  }

  .history-panel.open { right: 0; }

  .history-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .history-header h3 {
    font-size: 15px;
    font-weight: 600;
  }

  .history-header-actions {
    display: flex;
    gap: 6px;
  }

  .history-header-actions button {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text-dim);
    padding: 4px 10px;
    border-radius: 5px;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.15s;
  }

  .history-header-actions button:hover {
    color: var(--text);
    border-color: var(--accent);
  }

  .history-list {
    flex: 1;
    overflow-y: auto;
    padding: 8px 0;
  }

  .history-list::-webkit-scrollbar { width: 6px; }
  .history-list::-webkit-scrollbar-track { background: transparent; }
  .history-list::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 3px;
  }

  .history-empty {
    text-align: center;
    color: var(--text-dim);
    padding: 40px 16px;
    font-size: 13px;
  }

  .history-date-group {
    padding: 8px 16px 4px;
    font-size: 11px;
    font-weight: 600;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .history-item {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 10px 16px;
    cursor: pointer;
    transition: background 0.1s;
    border-bottom: 1px solid var(--border);
  }

  .history-item:hover { background: var(--surface2); }

  .history-item-content {
    flex: 1;
    min-width: 0;
  }

  .history-item-title {
    font-size: 13px;
    font-weight: 500;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .history-item-url {
    font-size: 11px;
    color: var(--text-dim);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-top: 2px;
    font-family: 'SF Mono', 'Fira Code', monospace;
  }

  .history-item-time {
    font-size: 11px;
    color: var(--text-dim);
    white-space: nowrap;
    flex-shrink: 0;
    margin-top: 2px;
  }

  .history-item-delete {
    background: none;
    border: none;
    color: var(--text-dim);
    cursor: pointer;
    font-size: 14px;
    padding: 0 2px;
    opacity: 0;
    transition: opacity 0.1s;
    flex-shrink: 0;
  }

  .history-item:hover .history-item-delete { opacity: 1; }
  .history-item-delete:hover { color: var(--danger); }

  .history-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.3);
    z-index: 89;
    display: none;
  }

  .history-backdrop.open { display: block; }

  /* Feed panel (left side) */
  .feed-panel {
    position: fixed;
    top: 0;
    left: -420px;
    width: 420px;
    height: 100vh;
    background: var(--surface);
    border-right: 1px solid var(--border);
    z-index: 90;
    display: flex;
    flex-direction: column;
    transition: left 0.25s ease;
  }

  .feed-panel.open { left: 0; }

  .feed-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .feed-header h3 { font-size: 15px; font-weight: 600; }

  .feed-header-actions {
    display: flex;
    gap: 6px;
  }

  .feed-header-actions button {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text-dim);
    padding: 4px 10px;
    border-radius: 5px;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.15s;
  }

  .feed-header-actions button:hover {
    color: var(--text);
    border-color: var(--accent);
  }

  .feed-list {
    flex: 1;
    overflow-y: auto;
    padding: 8px 0;
  }

  .feed-list::-webkit-scrollbar { width: 6px; }
  .feed-list::-webkit-scrollbar-track { background: transparent; }
  .feed-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  .feed-empty {
    text-align: center;
    color: var(--text-dim);
    padding: 40px 16px;
    font-size: 13px;
    line-height: 1.6;
  }

  .feed-card {
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: background 0.1s;
  }

  .feed-card:hover { background: var(--surface2); }

  .feed-card-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .feed-card-url {
    font-size: 11px;
    color: var(--accent);
    font-family: 'SF Mono', 'Fira Code', monospace;
    margin-bottom: 6px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .feed-card-preview {
    font-size: 12px;
    color: var(--text-dim);
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    margin-bottom: 8px;
  }

  .feed-card-meta {
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 11px;
    color: var(--text-dim);
  }

  .feed-card-author {
    font-weight: 500;
    color: var(--text);
  }

  .feed-card-model {
    background: var(--bg);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 10px;
  }

  .feed-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.3);
    z-index: 89;
    display: none;
  }

  .feed-backdrop.open { display: block; }

</style>
</head>
<body>

<!-- Toolbar -->
<div class="toolbar">
  <div class="nav-buttons">
    <button class="nav-btn" id="backBtn" disabled title="Back">&#8592;</button>
    <button class="nav-btn" id="forwardBtn" disabled title="Forward">&#8594;</button>
  </div>

  <div class="address-bar">
    <span class="address-prefix">sidenet://</span>
    <input
      type="text"
      class="address-input"
      id="addressInput"
      placeholder="Enter a URL or describe a page..."
      autocomplete="off"
    />
  </div>

  <button class="go-btn" id="goBtn">Go</button>

  <div class="toolbar-right">
    <select class="model-select" id="modelSelect">
      <optgroup label="Free Models">
        <option value="nova-fast">Nova Micro — fastest, lightweight (22.2K/p)</option>
        <option value="mistral">Mistral Small 3.2 — compact, reliable (4.3K/p)</option>
        <option value="gemini-fast">Gemini 2.5 Flash — quick, balanced (3.1K/p)</option>
        <option value="qwen-coder">Qwen3 Coder 30B — code, technical (1.2K/p)</option>
        <option value="openai-fast">GPT-5 Nano — fast, versatile (950/p)</option>
        <option value="openai" selected>GPT-5 Mini — solid default (700/p)</option>
        <option value="claude-fast">Claude Haiku 4.5 — smart, concise (95/p)</option>
      </optgroup>
      <optgroup label="Paid Models (requires Pollen)">
        <option value="openai-large">GPT-5.2 — powerful, detailed (90/p)</option>
        <option value="gemini">Gemini 3 Flash — fast, premium (85/p)</option>
        <option value="grok">Grok 4 Fast — creative, bold (550/p)</option>
        <option value="claude">Claude Sonnet 4.5 — best quality (25/p)</option>
      </optgroup>
    </select>
    <button class="settings-btn" id="feedBtn" title="Community Feed">&#9733;</button>
    <button class="settings-btn" id="historyBtn" title="History">&#9776;</button>
    <div class="settings-btn-wrapper">
      <button class="settings-btn" id="settingsBtn" title="Settings">&#9881;</button>
      <div class="connection-dot" id="connectionDot"></div>
      <div class="connection-dot-tooltip">Get a free key at enter.pollinations.ai &rarr; paste in Settings</div>
    </div>
  </div>
</div>

<!-- Main content -->
<div class="content-area" id="contentArea">
  <div class="page-container" id="pageContainer">
    <div class="welcome-header">
      <div class="welcome-logo">sidenet</div>
      <p class="welcome-sub">Surf the sidenet.</p>
      <div class="welcome-hints">
        <div class="hint-chip" onclick="navigateTo('en.wikipedia.alt/wiki/The_Great_Martian_Canal_System')">wikipedia.alt/Martian Canals</div>
        <div class="hint-chip" onclick="navigateTo('news.alternate/2099/quantum-internet-goes-live')">Future News</div>
        <div class="hint-chip" onclick="navigateTo('recipes.alt/interdimensional-cooking/phase-shifted-pasta')">Interdimensional Recipes</div>
        <div class="hint-chip" onclick="navigateTo('shop.parallel/products/gravity-boots-pro')">Gravity Boots Store</div>
        <div class="hint-chip" onclick="navigateTo('A forum discussing the best places to visit in the dream world')">Dream Travel Forum</div>
      </div>
    </div>
    <div class="welcome-feed-section">
      <div class="welcome-feed-header">
        <h3>Today's Catch</h3>
        <button class="settings-btn" onclick="loadWelcomeFeed()" title="Refresh" style="width:auto;padding:0 8px;font-size:12px;height:28px">Refresh</button>
      </div>
      <div class="welcome-feed-list" id="welcomeFeedList">
        <div class="feed-empty">Loading community feed...</div>
      </div>
    </div>
  </div>
</div>

<!-- Feed panel -->
<div class="feed-backdrop" id="feedBackdrop"></div>
<div class="feed-panel" id="feedPanel">
  <div class="feed-header">
    <h3>Community Feed</h3>
    <div class="feed-header-actions">
      <button id="refreshFeedBtn">Refresh</button>
      <button id="closeFeedBtn">Close</button>
    </div>
  </div>
  <div class="feed-list" id="feedList">
    <div class="feed-empty">Loading community pages...</div>
  </div>
</div>

<!-- History panel -->
<div class="history-backdrop" id="historyBackdrop"></div>
<div class="history-panel" id="historyPanel">
  <div class="history-header">
    <h3>History</h3>
    <div class="history-header-actions">
      <button id="clearHistoryBtn">Clear all</button>
      <button id="closeHistoryBtn">Close</button>
    </div>
  </div>
  <div class="history-list" id="historyList">
    <div class="history-empty">No pages visited yet.</div>
  </div>
</div>

<!-- Settings modal -->
<div class="modal-overlay" id="settingsModal">
  <div class="modal">
    <h2>Settings</h2>
    <div class="form-group">
      <label>Pollinations API Key</label>
      <input type="password" id="apiKeyInput" placeholder="pk_... or sk_..." />
      <div class="form-hint">
        Optional for free models. Get a key at <a href="https://enter.pollinations.ai" target="_blank" style="color:var(--accent)">enter.pollinations.ai</a>
      </div>
      <div id="balanceDisplay" style="margin-top:6px;font-size:13px;color:var(--green);display:none">
        <span id="balanceAmount"></span>
      </div>
    </div>
    <div class="form-group">
      <label>Images per page (1-3)</label>
      <input type="number" id="imagesPerPage" min="1" max="3" value="2" />
      <div class="form-hint">How many AI images to generate per page</div>
    </div>
    <div class="form-group">
      <label>Temperature</label>
      <div class="temperature-control">
        <input type="range" id="temperatureSlider" min="0" max="2" step="0.05" value="0.85" />
        <span class="temperature-value" id="temperatureValue">0.85</span>
      </div>
      <div class="form-hint">Lower = more focused, Higher = more creative (default: 0.85)</div>
    </div>
    <div class="form-group">
      <label>System Prompt</label>
      <div class="prompt-preset-row">
        <select id="promptPresetSelect"></select>
        <button class="btn-icon" id="editPromptsBtn" title="Edit system prompts">&#9998;</button>
      </div>
      <div class="form-hint">Controls the AI's behavior and page generation style</div>
    </div>
    <hr style="border:none;border-top:1px solid var(--border);margin:20px 0" />
    <div class="form-group">
      <label>Display Name (for community feed)</label>
      <input type="text" id="displayNameInput" placeholder="Anonymous" style="font-family:inherit" />
      <div class="form-hint">Shown when you share pages to the feed</div>
    </div>
    <div class="modal-actions">
      <button class="btn-secondary" id="cancelSettings">Cancel</button>
      <button class="btn-primary" id="saveSettings">Save</button>
    </div>
  </div>
</div>

<!-- System Prompt Editor modal -->
<div class="modal-overlay prompt-editor-overlay" id="promptEditorModal">
  <div class="modal prompt-editor-modal">
    <h2>Edit System Prompt</h2>
    <div class="form-group">
      <label>Preset Name</label>
      <input type="text" id="promptNameInput" placeholder="My Custom Prompt" style="font-family:inherit" />
    </div>
    <div class="form-group">
      <label>System Prompt</label>
      <textarea id="promptTextarea" placeholder="Enter your system prompt here..."></textarea>
    </div>
    <div class="prompt-editor-actions">
      <div class="left-actions">
        <button class="btn-danger" id="deletePromptBtn">Delete</button>
        <button class="btn-secondary" id="resetPromptBtn">Reset to Default</button>
      </div>
      <div class="right-actions">
        <button class="btn-secondary" id="saveAsNewPromptBtn">Save as New</button>
        <button class="btn-primary" id="savePromptBtn">Save</button>
        <button class="btn-secondary" id="closePromptEditorBtn">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Duplicate URL modal -->
<div class="modal-overlay" id="duplicateModal">
  <div class="modal" style="width:380px;text-align:center">
    <h2 style="font-size:16px;margin-bottom:12px">Page Already Exists</h2>
    <p style="color:var(--text-dim);font-size:14px;margin-bottom:20px;line-height:1.6">
      A page like this has already been unearthed. Explore there instead?
    </p>
    <div class="modal-actions" style="justify-content:center">
      <button class="btn-secondary" id="duplicateNo">No, generate new</button>
      <button class="btn-primary" id="duplicateYes">Yes, take me there</button>
    </div>
  </div>
</div>

<!-- Constellation overlay -->
<div class="constellation-wrapper" id="constellationWrapper">
  <canvas class="constellation-canvas" id="constellationCanvas"></canvas>
</div>

<script>
// ── State ──
// ── Hardcoded Firebase config ──
const FIREBASE_CONFIG = {
  apiKey: "__FIREBASE_API_KEY__",
  authDomain: "__FIREBASE_AUTH_DOMAIN__",
  databaseURL: "__FIREBASE_DATABASE_URL__",
  projectId: "sidenet-61c6d",
  storageBucket: "__FIREBASE_STORAGE_BUCKET__",
  messagingSenderId: "__FIREBASE_MESSAGING_SENDER_ID__",
  appId: "1:__FIREBASE_MESSAGING_SENDER_ID__:web:82aa4199ba940a05db5c6f",
};

const DEFAULT_SYSTEM_PROMPT = `You are sidenet, an AI that generates creative, detailed HTML pages for an alternate-reality internet browser.

RULES:
- Output ONLY raw HTML content (no \`\`\`html blocks, no markdown, no explanations)
- Use semantic HTML: h1, h2, h3, p, ul, ol, blockquote, table, pre, code, hr, etc.
- Include 1-3 images using this EXACT format: <img data-ai-prompt="detailed image description here" alt="description" />
- Include 3-6 hyperlinks using this format: <a href="sidenet://some-url-path">Link Text</a>
  - Links should point to related pages on this alternate internet
  - Use creative, plausible URLs like sidenet://en.wikipedia.alt/wiki/Topic or sidenet://news.alt/article-slug
- Make the content creative, detailed, internally consistent, and immersive
- Pages should feel like real websites from a parallel universe - wikis, shops, forums, news sites, blogs, documentation, etc.
- Be inventive with alternate history, science, culture, and technology
- Content should be 300-600 words
- Do NOT include <html>, <head>, <body>, or <style> tags - just the inner content`;

const state = {
  apiKey: localStorage.getItem('sidenet_apiKey') || '',
  imagesPerPage: parseInt(localStorage.getItem('sidenet_imagesPerPage') || '2'),
  displayName: localStorage.getItem('sidenet_displayName') || '',
  temperature: parseFloat(localStorage.getItem('sidenet_temperature') || '0.85'),
  activePromptId: localStorage.getItem('sidenet_activePromptId') || 'default',
  systemPromptPresets: JSON.parse(localStorage.getItem('sidenet_systemPromptPresets') || 'null') || {
    default: { name: 'Default sidenet', prompt: DEFAULT_SYSTEM_PROMPT }
  },
  history: [],
  historyIndex: -1,
  isLoading: false,
  firebaseReady: false,
  firebaseUid: null,
  settingsSynced: false,
  currentFeedKey: null,
  currentExplorationId: null,
};

// ── DOM refs ──
const $ = (sel) => document.querySelector(sel);
const addressInput = $('#addressInput');
const goBtn = $('#goBtn');
const backBtn = $('#backBtn');
const forwardBtn = $('#forwardBtn');
const modelSelect = $('#modelSelect');
const settingsBtn = $('#settingsBtn');
const settingsModal = $('#settingsModal');
const apiKeyInput = $('#apiKeyInput');
const imagesPerPageInput = $('#imagesPerPage');
const saveSettingsBtn = $('#saveSettings');
const cancelSettingsBtn = $('#cancelSettings');
const pageContainer = $('#pageContainer');
const connectionDot = $('#connectionDot');
const historyBtn = $('#historyBtn');
const historyPanel = $('#historyPanel');
const historyBackdrop = $('#historyBackdrop');
const historyList = $('#historyList');
const clearHistoryBtn = $('#clearHistoryBtn');
const closeHistoryBtn = $('#closeHistoryBtn');
const feedBtn = $('#feedBtn');
const feedPanel = $('#feedPanel');
const feedBackdrop = $('#feedBackdrop');
const feedList = $('#feedList');
const refreshFeedBtn = $('#refreshFeedBtn');
const closeFeedBtn = $('#closeFeedBtn');
const displayNameInput = $('#displayNameInput');
const welcomeFeedList = $('#welcomeFeedList');
const temperatureSlider = $('#temperatureSlider');
const temperatureValue = $('#temperatureValue');
const promptPresetSelect = $('#promptPresetSelect');
const editPromptsBtn = $('#editPromptsBtn');
const promptEditorModal = $('#promptEditorModal');
const promptNameInput = $('#promptNameInput');
const promptTextarea = $('#promptTextarea');
const deletePromptBtn = $('#deletePromptBtn');
const resetPromptBtn = $('#resetPromptBtn');
const saveAsNewPromptBtn = $('#saveAsNewPromptBtn');
const savePromptBtn = $('#savePromptBtn');
const closePromptEditorBtn = $('#closePromptEditorBtn');

// ── Init ──
let firebaseDb = null;
let firebaseAuth = null;
updateStatusBar();
apiKeyInput.value = state.apiKey;
imagesPerPageInput.value = state.imagesPerPage;
displayNameInput.value = state.displayName;
temperatureSlider.value = state.temperature;
temperatureValue.textContent = state.temperature.toFixed(2);
populatePromptPresetSelect();
initFirebase();

// ── Settings ──
settingsBtn.addEventListener('click', () => {
  settingsModal.classList.add('open');
  apiKeyInput.value = state.apiKey;
  imagesPerPageInput.value = state.imagesPerPage;
  displayNameInput.value = state.displayName;
  temperatureSlider.value = state.temperature;
  temperatureValue.textContent = state.temperature.toFixed(2);
  populatePromptPresetSelect();
  fetchBalance();
});

cancelSettingsBtn.addEventListener('click', () => settingsModal.classList.remove('open'));

temperatureSlider.addEventListener('input', () => {
  temperatureValue.textContent = parseFloat(temperatureSlider.value).toFixed(2);
});

settingsModal.addEventListener('click', (e) => {
  if (e.target === settingsModal) settingsModal.classList.remove('open');
});

saveSettingsBtn.addEventListener('click', () => {
  state.apiKey = apiKeyInput.value.trim();
  state.imagesPerPage = Math.min(3, Math.max(1, parseInt(imagesPerPageInput.value) || 2));
  state.displayName = displayNameInput.value.trim();
  state.temperature = parseFloat(temperatureSlider.value);
  state.activePromptId = promptPresetSelect.value;
  localStorage.setItem('sidenet_apiKey', state.apiKey);
  localStorage.setItem('sidenet_imagesPerPage', state.imagesPerPage);
  localStorage.setItem('sidenet_displayName', state.displayName);
  localStorage.setItem('sidenet_temperature', state.temperature);
  localStorage.setItem('sidenet_activePromptId', state.activePromptId);
  saveSettingsToFirebase();
  settingsModal.classList.remove('open');
  updateStatusBar();
});

function updateStatusBar() {
  if (!connectionDot) return;
  if (state.apiKey) {
    connectionDot.classList.add('connected');
  } else {
    connectionDot.classList.remove('connected');
  }
}

const POLLEN_PER_RESPONSE = {
  'nova-fast': 22200, 'mistral': 4300, 'gemini-fast': 3100,
  'qwen-coder': 1200, 'openai-fast': 950, 'openai': 700,
  'grok': 550, 'claude-fast': 95, 'openai-large': 90,
  'gemini': 85, 'claude': 25,
};

async function fetchBalance() {
  const el = document.getElementById('balanceDisplay');
  const amt = document.getElementById('balanceAmount');
  if (!el || !amt) return;
  if (!state.apiKey) { el.style.display = 'none'; return; }
  try {
    const resp = await fetch('https://gen.pollinations.ai/account/balance', {
      headers: { 'Authorization': `Bearer ${state.apiKey}` }
    });
    if (!resp.ok) throw new Error('Failed');
    const data = await resp.json();
    const balance = typeof data === 'number' ? data : (data.balance ?? data);
    const model = modelSelect.value;
    const rate = POLLEN_PER_RESPONSE[model];
    const estGen = rate ? `~${Math.floor(balance * rate).toLocaleString()} pages on ${modelSelect.options[modelSelect.selectedIndex].text.split(' — ')[0]}` : '';
    amt.textContent = `${Number(balance).toFixed(2)} pollen${estGen ? ' · ' + estGen : ''}`;
    el.style.display = 'block';
  } catch {
    el.style.display = 'none';
  }
}

// ── System Prompt Presets ──
function populatePromptPresetSelect() {
  promptPresetSelect.innerHTML = '';
  for (const [id, preset] of Object.entries(state.systemPromptPresets)) {
    const opt = document.createElement('option');
    opt.value = id;
    opt.textContent = preset.name;
    promptPresetSelect.appendChild(opt);
  }
  promptPresetSelect.value = state.activePromptId;
  if (!promptPresetSelect.value && promptPresetSelect.options.length > 0) {
    promptPresetSelect.value = promptPresetSelect.options[0].value;
    state.activePromptId = promptPresetSelect.value;
  }
}

function savePresetsToStorage() {
  localStorage.setItem('sidenet_systemPromptPresets', JSON.stringify(state.systemPromptPresets));
  localStorage.setItem('sidenet_activePromptId', state.activePromptId);
  saveSettingsToFirebase();
}

function getActiveSystemPrompt() {
  const preset = state.systemPromptPresets[state.activePromptId];
  return preset ? preset.prompt : DEFAULT_SYSTEM_PROMPT;
}

editPromptsBtn.addEventListener('click', () => {
  const currentId = promptPresetSelect.value || state.activePromptId;
  const preset = state.systemPromptPresets[currentId];
  promptNameInput.value = preset ? preset.name : '';
  promptTextarea.value = preset ? preset.prompt : DEFAULT_SYSTEM_PROMPT;
  deletePromptBtn.disabled = (currentId === 'default');
  promptEditorModal.classList.add('open');
});

closePromptEditorBtn.addEventListener('click', () => {
  promptEditorModal.classList.remove('open');
});

promptEditorModal.addEventListener('click', (e) => {
  if (e.target === promptEditorModal) promptEditorModal.classList.remove('open');
});

savePromptBtn.addEventListener('click', () => {
  const currentId = promptPresetSelect.value || state.activePromptId;
  state.systemPromptPresets[currentId] = {
    name: promptNameInput.value.trim() || 'Untitled',
    prompt: promptTextarea.value,
  };
  state.activePromptId = currentId;
  savePresetsToStorage();
  populatePromptPresetSelect();
  promptEditorModal.classList.remove('open');
});

saveAsNewPromptBtn.addEventListener('click', () => {
  const newId = 'custom_' + Date.now();
  state.systemPromptPresets[newId] = {
    name: promptNameInput.value.trim() || 'Untitled',
    prompt: promptTextarea.value,
  };
  state.activePromptId = newId;
  savePresetsToStorage();
  populatePromptPresetSelect();
  promptEditorModal.classList.remove('open');
});

deletePromptBtn.addEventListener('click', () => {
  const currentId = promptPresetSelect.value || state.activePromptId;
  if (currentId === 'default') return;
  if (!confirm('Delete this prompt preset?')) return;
  delete state.systemPromptPresets[currentId];
  state.activePromptId = 'default';
  savePresetsToStorage();
  populatePromptPresetSelect();
  const d = state.systemPromptPresets['default'];
  promptNameInput.value = d.name;
  promptTextarea.value = d.prompt;
  deletePromptBtn.disabled = true;
});

resetPromptBtn.addEventListener('click', () => {
  promptTextarea.value = DEFAULT_SYSTEM_PROMPT;
  promptNameInput.value = 'Default sidenet';
});

// ── Navigation ──
addressInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !state.isLoading) {
    navigateTo(addressInput.value.trim());
  }
});

goBtn.addEventListener('click', () => {
  if (!state.isLoading) navigateTo(addressInput.value.trim());
});

backBtn.addEventListener('click', () => {
  if (state.historyIndex > 0) {
    state.historyIndex--;
    const entry = state.history[state.historyIndex];
    addressInput.value = entry.url;
    pageContainer.innerHTML = entry.html;
    bindPageLinks();
    updateNavButtons();
  }
});

forwardBtn.addEventListener('click', () => {
  if (state.historyIndex < state.history.length - 1) {
    state.historyIndex++;
    const entry = state.history[state.historyIndex];
    addressInput.value = entry.url;
    pageContainer.innerHTML = entry.html;
    bindPageLinks();
    updateNavButtons();
  }
});

function updateNavButtons() {
  backBtn.disabled = state.historyIndex <= 0;
  forwardBtn.disabled = state.historyIndex >= state.history.length - 1;
}

// ── Duplicate URL detection ──
function checkDuplicateUrl(query) {
  return new Promise((resolve) => {
    if (!state.firebaseReady || !firebaseDb) { resolve(null); return; }
    firebaseDb.ref('feed')
      .orderByChild('url')
      .equalTo(query.toLowerCase())
      .once('value')
      .then(snap => {
        if (snap.exists()) {
          const entries = [];
          snap.forEach(child => entries.push({ key: child.key, ...child.val() }));
          entries.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
          resolve(entries[0]);
        } else {
          resolve(null);
        }
      })
      .catch(() => resolve(null));
  });
}

function showDuplicateModal() {
  return new Promise((resolve) => {
    const modal = document.getElementById('duplicateModal');
    const yesBtn = document.getElementById('duplicateYes');
    const noBtn = document.getElementById('duplicateNo');
    modal.classList.add('open');
    function cleanup() {
      modal.classList.remove('open');
      yesBtn.removeEventListener('click', onYes);
      noBtn.removeEventListener('click', onNo);
      modal.removeEventListener('click', onBackdrop);
    }
    function onYes() { cleanup(); resolve('existing'); }
    function onNo() { cleanup(); resolve('generate'); }
    function onBackdrop(e) { if (e.target === modal) { cleanup(); resolve('generate'); } }
    yesBtn.addEventListener('click', onYes);
    noBtn.addEventListener('click', onNo);
    modal.addEventListener('click', onBackdrop);
  });
}

// ── Main page generation ──
async function navigateTo(query, { parentFeedKey, explorationId, parentHtml } = {}) {
  if (!query) return;

  // Check for duplicate URL in community feed
  const existingEntry = await checkDuplicateUrl(query);
  if (existingEntry) {
    const choice = await showDuplicateModal();
    if (choice === 'existing') {
      addressInput.value = existingEntry.url;
      pageContainer.innerHTML = existingEntry.html;
      bindPageLinks();
      state.history = state.history.slice(0, state.historyIndex + 1);
      state.history.push({ url: existingEntry.url, html: existingEntry.html });
      state.historyIndex = state.history.length - 1;
      updateNavButtons();
      state.currentFeedKey = existingEntry.key || null;
      state.currentExplorationId = existingEntry.explorationId || null;
      $('#contentArea').scrollTop = 0;
      return;
    }
  }

  state.isLoading = true;
  goBtn.disabled = true;
  addressInput.value = query;

  // Show loading
  pageContainer.innerHTML = `
    <div class="loading-container">
      <div class="loading-spinner"></div>
      <div class="loading-text">Connecting to the alternate internet...</div>
      <div class="loading-step" id="loadingStep">Generating page content...</div>
    </div>
  `;

  // Determine storage URL (add suffix if duplicate)
  let storageUrl = query.toLowerCase();
  if (existingEntry) {
    try {
      const snap = await firebaseDb.ref('feed')
        .orderByChild('url')
        .startAt(query.toLowerCase())
        .endAt(query.toLowerCase() + '\uf8ff')
        .once('value');
      let count = 0;
      if (snap.exists()) snap.forEach(() => count++);
      storageUrl = query.toLowerCase() + '~' + (count + 1);
    } catch { /* use base url */ }
  }

  try {
    // Step 1: Generate page HTML
    const pageHTML = await generatePage(query);

    // Step 2: Parse out image placeholders and render page
    const { html, imagePrompts } = parseAndInsertImages(pageHTML);
    pageContainer.innerHTML = `<div class="generated-page">${html}</div>`;

    // Step 3: Generate images in parallel
    const limitedPrompts = imagePrompts.slice(0, state.imagesPerPage);
    if (limitedPrompts.length > 0) {
      await generateImages(limitedPrompts);
    }

    // Bind link clicks
    bindPageLinks();

    // Save to session history
    state.history = state.history.slice(0, state.historyIndex + 1);
    state.history.push({ url: query, html: pageContainer.innerHTML });
    state.historyIndex = state.history.length - 1;
    updateNavButtons();

    // Save to persistent history
    const pageTitle = extractTitle(pageContainer.innerHTML) || query;
    const now = Date.now();
    savePersistentHistory({
      url: query,
      title: pageTitle,
      html: pageContainer.innerHTML,
      timestamp: now,
      model: modelSelect.value,
    });

    // Auto-publish to community feed and track exploration tree
    const feedKey = await publishToFeed(storageUrl, pageTitle, pageContainer.innerHTML);
    state.currentFeedKey = feedKey;
    updateExplorationTree(query, pageTitle, feedKey, pageContainer.innerHTML, { parentFeedKey, explorationId, parentHtml });

    // Scroll to top
    $('#contentArea').scrollTop = 0;

  } catch (err) {
    pageContainer.innerHTML = `
      <div class="page-container">
        <div class="error-banner">
          <strong>Connection failed:</strong> ${escapeHtml(err.message)}
        </div>
        <p style="color:var(--text-dim);margin-top:12px;">
          Check your API key in settings, or try a different model.
        </p>
      </div>
    `;
  }

  state.isLoading = false;
  goBtn.disabled = false;
}

// ── Text generation ──
async function generatePage(query) {
  const model = modelSelect.value;
  const systemPrompt = getActiveSystemPrompt();

  const userPrompt = `Generate the webpage for: ${query}

This is a page on the alternate internet. Create rich, immersive content with images and links to other pages.`;

  const response = await fetch('https://gen.pollinations.ai/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      ...(state.apiKey ? { 'Authorization': `Bearer ${state.apiKey}` } : {}),
    },
    body: JSON.stringify({
      model: model,
      messages: [
        { role: 'system', content: systemPrompt },
        { role: 'user', content: userPrompt },
      ],
      temperature: state.temperature,
      max_tokens: 2048,
    }),
  });

  if (!response.ok) {
    const errText = await response.text();
    throw new Error(`API error ${response.status}: ${errText.substring(0, 200)}`);
  }

  const data = await response.json();
  let content = data.choices[0].message.content;
  // Strip markdown code fences if the model wrapped its output
  content = content.replace(/^```html?\s*\n?/i, '').replace(/\n?```\s*$/i, '');
  return content;
}

// ── Image handling ──
function parseAndInsertImages(html) {
  const imagePrompts = [];
  let idx = 0;

  // Find all <img data-ai-prompt="..."> tags and replace with placeholders
  const processed = html.replace(
    /<img\s+data-ai-prompt="([^"]+)"[^>]*\/?>/gi,
    (match, prompt) => {
      const id = `ai-img-${idx}`;
      imagePrompts.push({ id, prompt });
      idx++;
      return `<div class="image-placeholder" id="${id}">Generating image: "${escapeHtml(prompt.substring(0, 80))}..."</div>`;
    }
  );

  return { html: processed, imagePrompts };
}

async function generateImages(prompts) {
  const promises = prompts.map(async ({ id, prompt }) => {
    try {
      const encodedPrompt = encodeURIComponent(prompt);
      const params = new URLSearchParams({
        model: 'flux',
        width: '768',
        height: '512',
        nologo: 'true',
      });
      if (state.apiKey) params.set('key', state.apiKey);

      const url = `https://image.pollinations.ai/prompt/${encodedPrompt}?${params}`;

      // Create image element and wait for load
      const placeholder = document.getElementById(id);
      if (!placeholder) return;

      const img = document.createElement('img');
      img.className = 'page-image';
      img.alt = prompt;
      img.src = url;

      await new Promise((resolve, reject) => {
        img.onload = resolve;
        img.onerror = () => {
          // Fallback: try gen.pollinations.ai endpoint
          const fallbackUrl = `https://gen.pollinations.ai/image/${encodedPrompt}?${params}`;
          img.onerror = reject;
          img.src = fallbackUrl;
        };
        // timeout after 60s
        setTimeout(resolve, 60000);
      });

      placeholder.replaceWith(img);
    } catch {
      const placeholder = document.getElementById(id);
      if (placeholder) {
        placeholder.textContent = '[Image failed to load]';
        placeholder.style.animation = 'none';
        placeholder.style.opacity = '0.4';
      }
    }
  });

  await Promise.allSettled(promises);
}

// ── Link binding ──
function bindPageLinks() {
  const parentHtml = pageContainer.innerHTML;
  pageContainer.querySelectorAll('a[href]').forEach((link) => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      let href = link.getAttribute('href');
      // Strip sidenet:// or legacy side:// prefix
      href = href.replace(/^(sidenet|side):\/\//, '');
      navigateTo(href, {
        parentFeedKey: state.currentFeedKey,
        explorationId: state.currentExplorationId,
        parentHtml,
      });
    });
  });
}

// ── Persistent History ──
function loadSavedHistory() {
  try {
    return JSON.parse(localStorage.getItem('sidenet_history') || '[]');
  } catch { return []; }
}

function savePersistentHistory(entry) {
  const saved = loadSavedHistory();
  saved.unshift(entry);
  // Keep max 200 entries, trim HTML to avoid hitting storage limits
  const trimmed = saved.slice(0, 200).map(e => ({
    ...e,
    html: (e.html || '').substring(0, 50000),
  }));
  try {
    localStorage.setItem('sidenet_history', JSON.stringify(trimmed));
  } catch {
    // Storage full — drop oldest half
    const halved = trimmed.slice(0, 100);
    localStorage.setItem('sidenet_history', JSON.stringify(halved));
  }
}

function deleteSavedHistoryEntry(timestamp) {
  const saved = loadSavedHistory().filter(e => e.timestamp !== timestamp);
  localStorage.setItem('sidenet_history', JSON.stringify(saved));
  renderHistoryPanel();
}

function clearSavedHistory() {
  localStorage.removeItem('sidenet_history');
  renderHistoryPanel();
}

function extractTitle(html) {
  const m = html.match(/<h1[^>]*>(.*?)<\/h1>/i);
  if (m) {
    const tmp = document.createElement('div');
    tmp.innerHTML = m[1];
    return tmp.textContent.substring(0, 100);
  }
  return null;
}

function formatTime(ts) {
  const d = new Date(ts);
  return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function formatDateGroup(ts) {
  const d = new Date(ts);
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const date = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const diff = (today - date) / 86400000;
  if (diff === 0) return 'Today';
  if (diff === 1) return 'Yesterday';
  if (diff < 7) return d.toLocaleDateString([], { weekday: 'long' });
  return d.toLocaleDateString([], { month: 'short', day: 'numeric', year: 'numeric' });
}

function renderHistoryPanel() {
  const saved = loadSavedHistory();
  if (saved.length === 0) {
    historyList.innerHTML = '<div class="history-empty">No pages visited yet.</div>';
    return;
  }

  let html = '';
  let currentGroup = '';

  for (const entry of saved) {
    const group = formatDateGroup(entry.timestamp);
    if (group !== currentGroup) {
      currentGroup = group;
      html += `<div class="history-date-group">${escapeHtml(group)}</div>`;
    }
    const title = escapeHtml(entry.title || entry.url);
    const url = escapeHtml(entry.url);
    const time = formatTime(entry.timestamp);
    html += `
      <div class="history-item" data-ts="${entry.timestamp}" data-url="${escapeHtml(entry.url)}">
        <div class="history-item-content">
          <div class="history-item-title">${title}</div>
          <div class="history-item-url">sidenet://${url}</div>
        </div>
        <span class="history-item-time">${time}</span>
        <button class="history-item-delete" data-delete-ts="${entry.timestamp}" title="Remove">&times;</button>
      </div>`;
  }

  historyList.innerHTML = html;

  // Bind clicks
  historyList.querySelectorAll('.history-item').forEach(item => {
    item.addEventListener('click', (e) => {
      if (e.target.closest('.history-item-delete')) return;
      const ts = parseInt(item.dataset.ts);
      const entry = loadSavedHistory().find(e => e.timestamp === ts);
      if (entry && entry.html) {
        // Restore cached page
        addressInput.value = entry.url;
        pageContainer.innerHTML = entry.html;
        bindPageLinks();
        // Push to session nav history
        state.history = state.history.slice(0, state.historyIndex + 1);
        state.history.push({ url: entry.url, html: entry.html });
        state.historyIndex = state.history.length - 1;
        updateNavButtons();
        $('#contentArea').scrollTop = 0;
      } else {
        // Re-generate if no cached HTML
        navigateTo(item.dataset.url);
      }
      toggleHistory(false);
    });
  });

  historyList.querySelectorAll('.history-item-delete').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      deleteSavedHistoryEntry(parseInt(btn.dataset.deleteTs));
    });
  });
}

function toggleHistory(forceOpen) {
  const open = forceOpen !== undefined ? forceOpen : !historyPanel.classList.contains('open');
  historyPanel.classList.toggle('open', open);
  historyBackdrop.classList.toggle('open', open);
  if (open) renderHistoryPanel();
}

historyBtn.addEventListener('click', () => toggleHistory());
closeHistoryBtn.addEventListener('click', () => toggleHistory(false));
historyBackdrop.addEventListener('click', () => toggleHistory(false));
clearHistoryBtn.addEventListener('click', () => {
  if (confirm('Clear all browsing history?')) clearSavedHistory();
});

// ── Firebase & Community Feed ──

function initFirebase() {
  try {
    if (typeof firebase === 'undefined' || typeof firebase.auth === 'undefined') {
      setTimeout(initFirebase, 500);
      return;
    }
    if (!firebase.apps.length) {
      firebase.initializeApp(FIREBASE_CONFIG);
    }
    firebaseDb = firebase.database();
    firebaseAuth = firebase.auth();

    firebaseAuth.onAuthStateChanged(async (user) => {
      if (user) {
        state.firebaseUid = user.uid;
        state.firebaseReady = true;
        await loadSettingsFromFirebase();
        loadWelcomeFeed();
      } else {
        firebaseAuth.signInAnonymously().catch((err) => {
          console.error('Anonymous auth failed:', err);
          state.firebaseReady = false;
          loadWelcomeFeed();
        });
      }
    });
  } catch (err) {
    console.error('Firebase init failed:', err);
    state.firebaseReady = false;
    loadWelcomeFeed();
  }
}

async function loadSettingsFromFirebase() {
  if (!state.firebaseReady || !firebaseDb || !state.firebaseUid) return;
  try {
    const snap = await firebaseDb.ref('users/' + state.firebaseUid + '/settings').once('value');
    const remote = snap.val();
    if (remote) {
      if (remote.temperature !== undefined) {
        state.temperature = remote.temperature;
        temperatureSlider.value = state.temperature;
        temperatureValue.textContent = state.temperature.toFixed(2);
      }
      if (remote.activePromptId !== undefined) {
        state.activePromptId = remote.activePromptId;
      }
      if (remote.systemPromptPresets !== undefined) {
        state.systemPromptPresets = remote.systemPromptPresets;
      }
      if (remote.displayName !== undefined) {
        state.displayName = remote.displayName;
        displayNameInput.value = state.displayName;
      }
      if (remote.imagesPerPage !== undefined) {
        state.imagesPerPage = remote.imagesPerPage;
        imagesPerPageInput.value = state.imagesPerPage;
      }
      populatePromptPresetSelect();
      localStorage.setItem('sidenet_temperature', state.temperature);
      localStorage.setItem('sidenet_activePromptId', state.activePromptId);
      localStorage.setItem('sidenet_systemPromptPresets', JSON.stringify(state.systemPromptPresets));
      localStorage.setItem('sidenet_displayName', state.displayName);
      localStorage.setItem('sidenet_imagesPerPage', state.imagesPerPage);
    } else {
      await saveSettingsToFirebase();
    }
    state.settingsSynced = true;
  } catch (err) {
    console.error('Failed to load settings from Firebase:', err);
  }
}

function saveSettingsToFirebase() {
  if (!state.firebaseReady || !firebaseDb || !state.firebaseUid) return;
  return firebaseDb.ref('users/' + state.firebaseUid + '/settings').set({
    temperature: state.temperature,
    activePromptId: state.activePromptId,
    systemPromptPresets: state.systemPromptPresets,
    displayName: state.displayName,
    imagesPerPage: state.imagesPerPage,
    lastUpdated: Date.now(),
  }).catch((err) => {
    console.error('Failed to save settings to Firebase:', err);
  });
}

function publishToFeed(url, title, html) {
  if (!state.firebaseReady || !firebaseDb) return Promise.resolve(null);
  const cleanHtml = html.substring(0, 40000);
  const tmp = document.createElement('div');
  tmp.innerHTML = cleanHtml;
  const preview = tmp.textContent.substring(0, 200).trim();

  const newRef = firebaseDb.ref('feed').push();
  const feedKey = newRef.key;
  return newRef.set({
    url: url.toLowerCase(),
    title: title || url,
    preview,
    html: cleanHtml,
    author: state.displayName || 'Anonymous',
    model: modelSelect.value,
    timestamp: Date.now(),
    explorationId: null,
  }).then(() => feedKey).catch(() => null);
}

function computeContentDiff(parentHtml, childHtml) {
  const toText = (h) => { const t = document.createElement('div'); t.innerHTML = h; return t.textContent || ''; };
  const parentWords = new Set(toText(parentHtml).toLowerCase().split(/\s+/).filter(w => w.length > 2));
  const childWords = toText(childHtml).toLowerCase().split(/\s+/).filter(w => w.length > 2);
  let newCount = 0;
  for (const w of childWords) { if (!parentWords.has(w)) newCount++; }
  return { size: newCount };
}

function extractNewConcepts(parentHtml, childHtml) {
  const concepts = [];
  const parentEl = document.createElement('div');
  parentEl.innerHTML = parentHtml;
  const childEl = document.createElement('div');
  childEl.innerHTML = childHtml;

  // New headings
  const parentHeadings = new Set([...parentEl.querySelectorAll('h1,h2,h3')].map(h => h.textContent.trim().toLowerCase()));
  for (const h of childEl.querySelectorAll('h1,h2,h3')) {
    const text = h.textContent.trim();
    if (text && !parentHeadings.has(text.toLowerCase())) concepts.push(text.substring(0, 60));
  }

  // New link texts
  const parentLinks = new Set([...parentEl.querySelectorAll('a')].map(a => a.textContent.trim().toLowerCase()));
  for (const a of childEl.querySelectorAll('a')) {
    const text = a.textContent.trim();
    if (text && text.length > 3 && !parentLinks.has(text.toLowerCase())) concepts.push(text.substring(0, 60));
  }

  // New bold/strong text
  const parentBold = new Set([...parentEl.querySelectorAll('strong,b')].map(b => b.textContent.trim().toLowerCase()));
  for (const b of childEl.querySelectorAll('strong,b')) {
    const text = b.textContent.trim();
    if (text && text.length > 3 && !parentBold.has(text.toLowerCase())) concepts.push(text.substring(0, 60));
  }

  return [...new Set(concepts)].slice(0, 8);
}

async function updateExplorationTree(url, title, feedKey, html, { parentFeedKey, explorationId, parentHtml }) {
  if (!state.firebaseReady || !firebaseDb || !feedKey) return;
  try {
    if (explorationId && parentFeedKey && parentHtml) {
      // Child navigation (link click) — extend existing tree
      const diffResult = computeContentDiff(parentHtml, html);
      const concepts = extractNewConcepts(parentHtml, html);

      // Find parent node by feedKey (client-side scan)
      const nodesSnap = await firebaseDb.ref('explorations/' + explorationId + '/nodes').once('value');
      let parentNodeId = null;
      if (nodesSnap.exists()) {
        nodesSnap.forEach(child => {
          if (child.val().feedKey === parentFeedKey) parentNodeId = child.key;
        });
      }

      const newNodeRef = firebaseDb.ref('explorations/' + explorationId + '/nodes').push();
      await newNodeRef.set({
        url: url.toLowerCase(),
        title: title,
        parentNodeId: parentNodeId,
        feedKey: feedKey,
        timestamp: Date.now(),
        diffSize: diffResult.size,
        concepts: concepts,
      });

      await firebaseDb.ref('feed/' + feedKey + '/explorationId').set(explorationId);
      state.currentExplorationId = explorationId;
    } else {
      // New root (user typed URL)
      const newExplorationRef = firebaseDb.ref('explorations').push();
      const newExplorationId = newExplorationRef.key;
      const newNodeRef = newExplorationRef.child('nodes').push();

      await newExplorationRef.set({
        rootUrl: url.toLowerCase(),
        authorUid: state.firebaseUid || null,
        author: state.displayName || 'Anonymous',
        createdAt: Date.now(),
        nodes: {
          [newNodeRef.key]: {
            url: url.toLowerCase(),
            title: title,
            parentNodeId: null,
            feedKey: feedKey,
            timestamp: Date.now(),
            diffSize: 0,
            concepts: [],
          }
        }
      });

      await firebaseDb.ref('feed/' + feedKey + '/explorationId').set(newExplorationId);
      state.currentExplorationId = newExplorationId;
    }
  } catch (err) {
    console.error('Exploration tree update failed:', err);
  }
}

async function loadFeed() {
  if (!state.firebaseReady || !firebaseDb) {
    feedList.innerHTML = `<div class="feed-empty">Community feed connecting...</div>`;
    setTimeout(() => { if (state.firebaseReady) loadFeed(); }, 1000);
    return;
  }
  feedList.innerHTML = '<div class="feed-empty">Loading...</div>';
  try {
    const snap = await firebaseDb.ref('feed')
      .orderByChild('timestamp')
      .limitToLast(50)
      .once('value');
    const entries = [];
    snap.forEach(child => {
      entries.push({ key: child.key, ...child.val() });
    });
    entries.reverse(); // newest first
    renderFeed(entries);
  } catch (err) {
    feedList.innerHTML = `<div class="feed-empty">Error loading feed: ${escapeHtml(err.message)}</div>`;
  }
}

function renderFeed(entries) {
  if (entries.length === 0) {
    feedList.innerHTML = '<div class="feed-empty">No shared pages yet. Be the first to share!</div>';
    return;
  }

  let html = '';
  for (const entry of entries) {
    const title = escapeHtml(entry.title || entry.url);
    const url = escapeHtml(entry.url);
    const preview = escapeHtml(entry.preview || '');
    const author = escapeHtml(entry.author || 'Anonymous');
    const model = escapeHtml(entry.model || '?');
    const ago = timeAgo(entry.timestamp);
    html += `
      <div class="feed-card" data-feed-key="${escapeHtml(entry.key)}" data-exploration-id="${escapeHtml(entry.explorationId || '')}">
        <div class="feed-card-title">${title}</div>
        <div class="feed-card-url">sidenet://${url}</div>
        <div class="feed-card-preview">${preview}</div>
        <div class="feed-card-meta">
          <span><span class="feed-card-author">${author}</span> &middot; ${ago}</span>
          <span class="feed-card-model">${model}</span>
        </div>
      </div>`;
  }

  feedList.innerHTML = html;

  // Bind card clicks — load the shared page
  feedList.querySelectorAll('.feed-card').forEach(card => {
    card.addEventListener('click', async () => {
      hideConstellation();
      const key = card.dataset.feedKey;
      try {
        const snap = await firebaseDb.ref('feed/' + key).once('value');
        const entry = snap.val();
        if (entry && entry.html) {
          addressInput.value = entry.url;
          pageContainer.innerHTML = entry.html;
          bindPageLinks();
          state.history = state.history.slice(0, state.historyIndex + 1);
          state.history.push({ url: entry.url, html: pageContainer.innerHTML });
          state.historyIndex = state.history.length - 1;
          updateNavButtons();
          state.currentFeedKey = key;
          state.currentExplorationId = entry.explorationId || null;
          $('#contentArea').scrollTop = 0;
        } else {
          navigateTo(entry.url);
        }
      } catch {
        // Fallback: just navigate
        const url = card.querySelector('.feed-card-url').textContent.replace('sidenet://', '');
        navigateTo(url);
      }
      toggleFeed(false);
    });
  });
  bindConstellationHovers(feedList);
}

function timeAgo(ts) {
  const diff = Date.now() - ts;
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return 'just now';
  if (mins < 60) return `${mins}m ago`;
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return `${hrs}h ago`;
  const days = Math.floor(hrs / 24);
  if (days < 7) return `${days}d ago`;
  return new Date(ts).toLocaleDateString([], { month: 'short', day: 'numeric' });
}

function toggleFeed(forceOpen) {
  const open = forceOpen !== undefined ? forceOpen : !feedPanel.classList.contains('open');
  feedPanel.classList.toggle('open', open);
  feedBackdrop.classList.toggle('open', open);
  if (open) loadFeed();
}

feedBtn.addEventListener('click', () => toggleFeed());
closeFeedBtn.addEventListener('click', () => toggleFeed(false));
feedBackdrop.addEventListener('click', () => toggleFeed(false));
refreshFeedBtn.addEventListener('click', () => loadFeed());

// ── Welcome page feed (inline) ──
async function loadWelcomeFeed() {
  if (!welcomeFeedList) return;
  if (!state.firebaseReady || !firebaseDb) {
    welcomeFeedList.innerHTML = '<div class="feed-empty">Connecting to community feed...</div>';
    return;
  }
  welcomeFeedList.innerHTML = '<div class="feed-empty">Loading community feed...</div>';
  try {
    const snap = await firebaseDb.ref('feed')
      .orderByChild('timestamp')
      .limitToLast(30)
      .once('value');
    const entries = [];
    snap.forEach(child => {
      entries.push({ key: child.key, ...child.val() });
    });
    entries.reverse();
    renderWelcomeFeed(entries);
  } catch (err) {
    welcomeFeedList.innerHTML = `<div class="feed-empty">Could not load feed: ${escapeHtml(err.message)}</div>`;
  }
}

function renderWelcomeFeed(entries) {
  if (!welcomeFeedList) return;
  if (entries.length === 0) {
    welcomeFeedList.innerHTML = '<div class="feed-empty">No pages yet. Generate something and it\'ll appear here!</div>';
    return;
  }
  let html = '';
  for (const entry of entries) {
    const title = escapeHtml(entry.title || entry.url);
    const url = escapeHtml(entry.url);
    const preview = escapeHtml(entry.preview || '');
    const author = escapeHtml(entry.author || 'Anonymous');
    const model = escapeHtml(entry.model || '?');
    const ago = timeAgo(entry.timestamp);
    html += `
      <div class="feed-card" data-feed-key="${escapeHtml(entry.key)}" data-exploration-id="${escapeHtml(entry.explorationId || '')}">
        <div class="feed-card-title">${title}</div>
        <div class="feed-card-url">sidenet://${url}</div>
        <div class="feed-card-preview">${preview}</div>
        <div class="feed-card-meta">
          <span><span class="feed-card-author">${author}</span> &middot; ${ago}</span>
          <span class="feed-card-model">${model}</span>
        </div>
      </div>`;
  }
  welcomeFeedList.innerHTML = html;

  // Bind card clicks
  welcomeFeedList.querySelectorAll('.feed-card').forEach(card => {
    card.addEventListener('click', async () => {
      hideConstellation();
      const key = card.dataset.feedKey;
      try {
        const snap = await firebaseDb.ref('feed/' + key).once('value');
        const entry = snap.val();
        if (entry && entry.html) {
          addressInput.value = entry.url;
          pageContainer.innerHTML = entry.html;
          bindPageLinks();
          state.history = state.history.slice(0, state.historyIndex + 1);
          state.history.push({ url: entry.url, html: pageContainer.innerHTML });
          state.historyIndex = state.history.length - 1;
          updateNavButtons();
          state.currentFeedKey = key;
          state.currentExplorationId = entry.explorationId || null;
          $('#contentArea').scrollTop = 0;
        } else {
          navigateTo(entry.url);
        }
      } catch {
        const url = card.querySelector('.feed-card-url').textContent.replace('sidenet://', '');
        navigateTo(url);
      }
    });
  });
  bindConstellationHovers(welcomeFeedList);
}

// ── Constellation Renderer ──
class ConstellationRenderer {
  constructor(canvas) {
    this.canvas = canvas;
    this.ctx = canvas.getContext('2d');
    this.nodes = [];
    this.edges = [];
    this.branches = [];
    this.panX = 0;
    this.targetPanX = 0;
    this.totalWidth = 600;
    this.animFrame = null;
    this.dpr = window.devicePixelRatio || 1;
    this._stars = null;
  }

  layoutTree(treeData) {
    this.nodes = [];
    this.edges = [];
    this.branches = [];

    if (!treeData || !treeData.nodes) {
      this._layoutSingleNode(treeData);
      return;
    }

    const nodeEntries = Object.entries(treeData.nodes)
      .map(([id, n]) => ({ id, ...n }))
      .sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));

    if (nodeEntries.length === 0) { this._layoutSingleNode(treeData); return; }

    const root = nodeEntries.find(n => !n.parentNodeId) || nodeEntries[0];
    const children = {};
    for (const n of nodeEntries) {
      if (n.parentNodeId) {
        if (!children[n.parentNodeId]) children[n.parentNodeId] = [];
        children[n.parentNodeId].push(n);
      }
    }

    const SPINE_Y = this.canvas.height / (2 * this.dpr);
    const X_SPACING = 120;
    const maxDiff = Math.max(...nodeEntries.map(n => n.diffSize || 1), 1);
    let currentX = 60;

    const layout = (node, yOffset) => {
      const norm = (node.diffSize || 0) / maxDiff;
      const radius = 6 + norm * 14;
      const laid = { x: currentX, y: SPINE_Y + yOffset, radius, url: node.url || '', title: node.title || '', isRoot: !node.parentNodeId, concepts: node.concepts || [] };
      this.nodes.push(laid);

      if (laid.concepts.length > 0) {
        laid.concepts.forEach((c, i) => {
          const angle = -Math.PI / 4 - (i * Math.PI / 8);
          const len = 35 + Math.random() * 20;
          this.branches.push({ fromX: laid.x, fromY: laid.y, toX: laid.x + Math.cos(angle) * len, toY: laid.y + Math.sin(angle) * len, label: c });
        });
      }

      const kids = children[node.id] || [];
      kids.forEach((child, i) => {
        currentX += X_SPACING;
        const childY = (i - (kids.length - 1) / 2) * 40;
        const parent = laid;
        layout(child, childY);
        const childNode = this.nodes[this.nodes.length - 1];
        this.edges.push({ fromX: parent.x, fromY: parent.y, toX: childNode.x, toY: childNode.y });
      });

      if (kids.length === 0 && node !== root) return;
      if (kids.length === 0) return;
    };

    layout(root, 0);
    this.totalWidth = currentX + 60;
  }

  _layoutSingleNode(treeData) {
    const cx = this.canvas.width / (2 * this.dpr);
    const cy = this.canvas.height / (2 * this.dpr);
    this.nodes = [{ x: cx, y: cy, radius: 10, url: treeData?.rootUrl || '?', title: '', isRoot: true, concepts: [] }];
    this.totalWidth = this.canvas.width / this.dpr;
  }

  setPan(ratio) {
    const canvasW = this.canvas.width / this.dpr;
    const maxPan = Math.max(0, this.totalWidth - canvasW);
    this.targetPanX = -ratio * maxPan;
  }

  render() {
    this.panX += (this.targetPanX - this.panX) * 0.15;
    const ctx = this.ctx;
    const w = this.canvas.width;
    const h = this.canvas.height;
    ctx.clearRect(0, 0, w, h);
    ctx.save();
    ctx.scale(this.dpr, this.dpr);
    ctx.translate(this.panX, 0);

    // Background stars
    if (!this._stars) {
      this._stars = [];
      for (let i = 0; i < 60; i++) {
        this._stars.push({ x: Math.random() * this.totalWidth, y: Math.random() * (h / this.dpr), r: 0.3 + Math.random() * 1.2, a: 0.1 + Math.random() * 0.3 });
      }
    }
    for (const s of this._stars) {
      ctx.beginPath();
      ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
      ctx.fillStyle = `rgba(240,240,242,${s.a})`;
      ctx.fill();
    }

    // Edges
    ctx.strokeStyle = 'rgba(240,200,216,0.2)';
    ctx.lineWidth = 1;
    for (const e of this.edges) {
      ctx.beginPath();
      const mx = (e.fromX + e.toX) / 2;
      ctx.moveTo(e.fromX, e.fromY);
      ctx.bezierCurveTo(mx, e.fromY, mx, e.toY, e.toX, e.toY);
      ctx.stroke();
    }

    // Concept branches
    ctx.strokeStyle = 'rgba(240,200,216,0.12)';
    ctx.lineWidth = 0.5;
    ctx.font = '9px system-ui, sans-serif';
    ctx.fillStyle = 'rgba(144,144,160,0.7)';
    for (const b of this.branches) {
      ctx.beginPath();
      ctx.moveTo(b.fromX, b.fromY);
      ctx.lineTo(b.toX, b.toY);
      ctx.stroke();
      ctx.beginPath();
      ctx.arc(b.toX, b.toY, 2, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillText(b.label, b.toX + 4, b.toY + 3);
    }

    // Nodes
    for (const n of this.nodes) {
      const g = ctx.createRadialGradient(n.x, n.y, 0, n.x, n.y, n.radius * 2.5);
      g.addColorStop(0, n.isRoot ? 'rgba(240,200,216,0.3)' : 'rgba(240,200,216,0.15)');
      g.addColorStop(1, 'rgba(240,200,216,0)');
      ctx.fillStyle = g;
      ctx.beginPath();
      ctx.arc(n.x, n.y, n.radius * 2.5, 0, Math.PI * 2);
      ctx.fill();

      ctx.beginPath();
      ctx.arc(n.x, n.y, n.radius, 0, Math.PI * 2);
      ctx.fillStyle = n.isRoot ? '#f0c8d8' : 'rgba(240,200,216,0.7)';
      ctx.fill();

      ctx.font = '10px "SF Mono","Fira Code",monospace';
      ctx.fillStyle = 'rgba(240,240,242,0.5)';
      ctx.textAlign = 'center';
      const label = (n.url || '').length > 25 ? n.url.substring(0, 22) + '...' : n.url;
      ctx.fillText(label, n.x, n.y + n.radius + 14);
      ctx.textAlign = 'left';
    }

    ctx.restore();
    this.animFrame = requestAnimationFrame(() => this.render());
  }

  start() { if (!this.animFrame) this.render(); }
  stop() { if (this.animFrame) { cancelAnimationFrame(this.animFrame); this.animFrame = null; } }
  reset() {
    this.stop();
    this.nodes = [];
    this.edges = [];
    this.branches = [];
    this._stars = null;
    this.panX = 0;
    this.targetPanX = 0;
  }
}

// ── Constellation Hover Controller ──
const constellationWrapper = $('#constellationWrapper');
const constellationCanvas = $('#constellationCanvas');
const constellationCache = new Map();
let constellationRenderer = null;
let constellationHoverTimeout = null;
const CONSTELLATION_W = 560;
const CONSTELLATION_H = 200;

function showConstellation(card) {
  const explorationId = card.dataset.explorationId;
  if (!explorationId) { showSingleNodeConstellation(card); return; }

  const cached = constellationCache.get(explorationId);
  if (cached && (Date.now() - cached.at < 300000)) {
    renderConstellation(card, cached.data);
    return;
  }

  if (!state.firebaseReady || !firebaseDb) { showSingleNodeConstellation(card); return; }

  firebaseDb.ref('explorations/' + explorationId).once('value')
    .then(snap => {
      const data = snap.val();
      if (data) {
        constellationCache.set(explorationId, { data, at: Date.now() });
        if (card.matches(':hover')) renderConstellation(card, data);
      } else {
        showSingleNodeConstellation(card);
      }
    })
    .catch(() => showSingleNodeConstellation(card));
}

function showSingleNodeConstellation(card) {
  const url = card.querySelector('.feed-card-url')?.textContent?.replace('sidenet://', '') || '?';
  renderConstellation(card, { rootUrl: url, nodes: null });
}

function renderConstellation(card, treeData) {
  if (!constellationRenderer) constellationRenderer = new ConstellationRenderer(constellationCanvas);
  const dpr = window.devicePixelRatio || 1;
  constellationCanvas.width = CONSTELLATION_W * dpr;
  constellationCanvas.height = CONSTELLATION_H * dpr;
  constellationCanvas.style.width = CONSTELLATION_W + 'px';
  constellationCanvas.style.height = CONSTELLATION_H + 'px';

  constellationRenderer.reset();
  constellationRenderer.layoutTree(treeData);

  const rect = card.getBoundingClientRect();
  let left = rect.left + rect.width / 2 - CONSTELLATION_W / 2;
  let top = rect.top > CONSTELLATION_H + 16 ? rect.top - CONSTELLATION_H - 8 : rect.bottom + 8;
  left = Math.max(8, Math.min(left, window.innerWidth - CONSTELLATION_W - 8));
  constellationWrapper.style.left = left + 'px';
  constellationWrapper.style.top = top + 'px';
  constellationWrapper.style.width = CONSTELLATION_W + 'px';
  constellationWrapper.style.height = CONSTELLATION_H + 'px';

  constellationWrapper.classList.add('visible');
  constellationRenderer.start();
}

function hideConstellation() {
  constellationWrapper.classList.remove('visible');
  if (constellationRenderer) constellationRenderer.stop();
}

function bindConstellationHovers(container) {
  container.querySelectorAll('.feed-card').forEach(card => {
    card.addEventListener('mouseenter', () => {
      clearTimeout(constellationHoverTimeout);
      constellationHoverTimeout = setTimeout(() => showConstellation(card), 200);
    });
    card.addEventListener('mousemove', (e) => {
      if (constellationRenderer && constellationWrapper.classList.contains('visible')) {
        const rect = card.getBoundingClientRect();
        const ratio = (e.clientX - rect.left) / rect.width;
        constellationRenderer.setPan(Math.max(0, Math.min(1, ratio)));
      }
    });
    card.addEventListener('mouseleave', () => {
      clearTimeout(constellationHoverTimeout);
      hideConstellation();
    });
  });
}

// ── Utils ──
function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}
</script>
</body>
</html>
